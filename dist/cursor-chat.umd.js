(function(V,B){typeof exports=="object"&&typeof module!="undefined"?B(exports):typeof define=="function"&&define.amd?define(["exports"],B):(V=typeof globalThis!="undefined"?globalThis:V||self,B(V["cursor-chat"]={}))})(this,function(V){"use strict";var Cc=Object.defineProperty,vc=Object.defineProperties;var Dc=Object.getOwnPropertyDescriptors;var ar=Object.getOwnPropertySymbols;var Ec=Object.prototype.hasOwnProperty,Ac=Object.prototype.propertyIsEnumerable;var hr=(V,B,T)=>B in V?Cc(V,B,{enumerable:!0,configurable:!0,writable:!0,value:T}):V[B]=T,Ht=(V,B)=>{for(var T in B||(B={}))Ec.call(B,T)&&hr(V,T,B[T]);if(ar)for(var T of ar(B))Ac.call(B,T)&&hr(V,T,B[T]);return V},xe=(V,B)=>vc(V,Dc(B));var B="";const T=()=>new Map,Ue=e=>{const t=T();return e.forEach((n,s)=>{t.set(s,n)}),t},nt=(e,t,n)=>{let s=e.get(t);return s===void 0&&e.set(t,s=n()),s},ur=(e,t)=>{const n=[];for(const[s,r]of e)n.push(t(r,s));return n},dr=(e,t)=>{for(const[n,s]of e)if(t(s,n))return!0;return!1},bt=()=>new Set,Re=e=>e[e.length-1],fr=(e,t)=>{for(let n=0;n<t.length;n++)e.push(t[n])},ut=Array.from,gr=Array.isArray;class In{constructor(){this._observers=T()}on(t,n){nt(this._observers,t,bt).add(n)}once(t,n){const s=(...r)=>{this.off(t,s),n(...r)};this.on(t,s)}off(t,n){const s=this._observers.get(t);s!==void 0&&(s.delete(n),s.size===0&&this._observers.delete(t))}emit(t,n){return ut((this._observers.get(t)||T()).values()).forEach(s=>s(...n))}destroy(){this._observers=T()}}const st=Math.floor,ce=Math.abs,Mn=(e,t)=>e<t?e:t,St=(e,t)=>e>t?e:t,Ln=e=>e!==0?e<0:1/e<0,Tn=1,On=2,Ne=4,Ve=8,Gt=32,rt=64,J=128,le=31,Fe=63,kt=127,pr=2147483647,xn=Number.MAX_SAFE_INTEGER,wr=Number.isInteger||(e=>typeof e=="number"&&isFinite(e)&&st(e)===e),mr=String.fromCharCode,yr=e=>e.toLowerCase(),br=/^\s*/g,Sr=e=>e.replace(br,""),kr=/([A-Z])/g,Un=(e,t)=>Sr(e.replace(kr,n=>`${t}${yr(n)}`)),_r=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.codePointAt(r);return s},Jt=typeof TextEncoder!="undefined"?new TextEncoder:null,Cr=Jt?e=>Jt.encode(e):_r;let Wt=typeof TextDecoder=="undefined"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Wt&&Wt.decode(new Uint8Array).length===1&&(Wt=null);class zt{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const G=()=>new zt,$e=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},O=e=>{const t=new Uint8Array($e(e));let n=0;for(let s=0;s<e.bufs.length;s++){const r=e.bufs[s];t.set(r,n),n+=r.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},vr=(e,t)=>{const n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(St(n,t)*2),e.cpos=0)},F=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},Be=F,b=(e,t)=>{for(;t>kt;)F(e,J|kt&t),t=st(t/128);F(e,kt&t)},je=(e,t)=>{const n=Ln(t);for(n&&(t=-t),F(e,(t>Fe?J:0)|(n?rt:0)|Fe&t),t=st(t/64);t>0;)F(e,(t>kt?J:0)|kt&t),t=st(t/128)},Pe=new Uint8Array(3e4),Dr=Pe.length/3,Er=(e,t)=>{if(t.length<Dr){const n=Jt.encodeInto(t,Pe).written||0;b(e,n);for(let s=0;s<n;s++)F(e,Pe[s])}else x(e,Cr(t))},Ar=(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;b(e,s);for(let r=0;r<s;r++)F(e,n.codePointAt(r))},_t=Jt&&Jt.encodeInto?Er:Ar,ae=(e,t)=>{const n=e.cbuf.length,s=e.cpos,r=Mn(n-s,t.length),i=t.length-r;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(St(n*2,i)),e.cbuf.set(t.subarray(r)),e.cpos=i)},x=(e,t)=>{b(e,t.byteLength),ae(e,t)},He=(e,t)=>{vr(e,t);const n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},Ir=(e,t)=>He(e,4).setFloat32(0,t,!1),Mr=(e,t)=>He(e,8).setFloat64(0,t,!1),Lr=(e,t)=>He(e,8).setBigInt64(0,t,!1),Rn=new DataView(new ArrayBuffer(4)),Tr=e=>(Rn.setFloat32(0,e),Rn.getFloat32(0)===e),Yt=(e,t)=>{switch(typeof t){case"string":F(e,119),_t(e,t);break;case"number":wr(t)&&ce(t)<=pr?(F(e,125),je(e,t)):Tr(t)?(F(e,124),Ir(e,t)):(F(e,123),Mr(e,t));break;case"bigint":F(e,122),Lr(e,t);break;case"object":if(t===null)F(e,126);else if(gr(t)){F(e,117),b(e,t.length);for(let n=0;n<t.length;n++)Yt(e,t[n])}else if(t instanceof Uint8Array)F(e,116),x(e,t);else{F(e,118);const n=Object.keys(t);b(e,n.length);for(let s=0;s<n.length;s++){const r=n[s];_t(e,r),Yt(e,t[r])}}break;case"boolean":F(e,t?120:121);break;default:F(e,127)}};class Nn extends zt{constructor(t){super();this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&b(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const Vn=e=>{e.count>0&&(je(e.encoder,e.count===1?e.s:-e.s),e.count>1&&b(e.encoder,e.count-2))};class he{constructor(){this.encoder=new zt,this.s=0,this.count=0}write(t){this.s===t?this.count++:(Vn(this),this.count=1,this.s=t)}toUint8Array(){return Vn(this),O(this.encoder)}}const Fn=e=>{if(e.count>0){const t=e.diff*2+(e.count===1?0:1);je(e.encoder,t),e.count>1&&b(e.encoder,e.count-2)}};class Ge{constructor(){this.encoder=new zt,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(Fn(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return Fn(this),O(this.encoder)}}class Or{constructor(){this.sarr=[],this.s="",this.lensE=new he}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new zt;return this.sarr.push(this.s),this.s="",_t(t,this.sarr.join("")),ae(t,this.lensE.toUint8Array()),O(t)}}const dt=e=>new Error(e),X=()=>{throw dt("Method unimplemented")},K=()=>{throw dt("Unexpected case")},$n=dt("Unexpected end of array"),Bn=dt("Integer out of Range");class ue{constructor(t){this.arr=t,this.pos=0}}const ft=e=>new ue(e),xr=e=>e.pos!==e.arr.length,Ur=(e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},H=e=>Ur(e,v(e)),Mt=e=>e.arr[e.pos++],v=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const r=e.arr[e.pos++];if(t=t+(r&kt)*n,n*=128,r<J)return t;if(t>xn)throw Bn}throw $n},Je=e=>{let t=e.arr[e.pos++],n=t&Fe,s=64;const r=(t&rt)>0?-1:1;if((t&J)===0)return r*n;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],n=n+(t&kt)*s,s*=128,t<J)return r*n;if(n>xn)throw Bn}throw $n},gt=Wt?e=>Wt.decode(H(e)):e=>{let t=v(e);if(t===0)return"";{let n=String.fromCodePoint(Mt(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Mt(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},We=(e,t)=>{const n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},Rr=[e=>{},e=>null,Je,e=>We(e,4).getFloat32(0,!1),e=>We(e,8).getFloat64(0,!1),e=>We(e,8).getBigInt64(0,!1),e=>!1,e=>!0,gt,e=>{const t=v(e),n={};for(let s=0;s<t;s++){const r=gt(e);n[r]=qt(e)}return n},e=>{const t=v(e),n=[];for(let s=0;s<t;s++)n.push(qt(e));return n},H],qt=e=>Rr[127-Mt(e)](e);class jn extends ue{constructor(t,n){super(t);this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),xr(this)?this.count=v(this)+1:this.count=-1),this.count--,this.s}}class de extends ue{constructor(t){super(t);this.s=0,this.count=0}read(){if(this.count===0){this.s=Je(this);const t=Ln(this.s);this.count=1,t&&(this.s=-this.s,this.count=v(this)+2)}return this.count--,this.s}}class ze extends ue{constructor(t){super(t);this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=Je(this),n=t&1;this.diff=st(t/2),this.count=1,n&&(this.count=v(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Nr{constructor(t){this.decoder=new de(t),this.str=gt(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),n=this.str.slice(this.spos,t);return this.spos=t,n}}const Vr=crypto.getRandomValues.bind(crypto),Pn=()=>Vr(new Uint32Array(1))[0],Fr=[1e7]+-1e3+-4e3+-8e3+-1e11,$r=()=>Fr.replace(/[018]/g,e=>(e^Pn()&15>>e/4).toString(16)),fe=Date.now,Hn=e=>new Promise(e);Promise.all.bind(Promise);const Gn=e=>e===void 0?null:e;class Br{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}}let Jn=new Br,Ye=!0;try{typeof localStorage!="undefined"&&localStorage&&(Jn=localStorage,Ye=!1)}catch{}const Wn=Jn,jr=e=>Ye||addEventListener("storage",e),Pr=e=>Ye||removeEventListener("storage",e),Hr=Object.assign,Gr=Object.keys,Jr=(e,t)=>{for(const n in e)t(e[n],n)},ge=e=>Gr(e).length,Wr=e=>{for(const t in e)return!1;return!0},zr=(e,t)=>{for(const n in e)if(!t(e[n],n))return!1;return!0},zn=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),Yr=(e,t)=>e===t||ge(e)===ge(t)&&zr(e,(n,s)=>(n!==void 0||zn(t,s))&&t[s]===n),qe=(e,t,n=0)=>{try{for(;n<e.length;n++)e[n](...t)}finally{n<e.length&&qe(e,t,n+1)}},qr=e=>e,Xr=(e,t)=>e===t,Xt=(e,t)=>{if(e==null||t==null)return Xr(e,t);if(e.constructor!==t.constructor)return!1;if(e===t)return!0;switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:{if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break}case Set:{if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break}case Map:{if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!Xt(e.get(n),t.get(n)))return!1;break}case Object:if(ge(e)!==ge(t))return!1;for(const n in e)if(!zn(e,n)||!Xt(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Xt(e[n],t[n]))return!1;break;default:return!1}return!0},Kr=(e,t)=>t.includes(e),Lt=typeof process!="undefined"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]",Yn=typeof window!="undefined"&&typeof document!="undefined"&&!Lt;typeof navigator!="undefined"&&/Mac/.test(navigator.platform);let Q;const Qr=()=>{if(Q===void 0)if(Lt){Q=T();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];s[0]==="-"?(t!==null&&Q.set(t,""),t=s):t!==null&&(Q.set(t,s),t=null)}t!==null&&Q.set(t,"")}else typeof location=="object"?(Q=T(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");Q.set(`--${Un(t,"-")}`,n),Q.set(`-${Un(t,"-")}`,n)}})):Q=T();return Q},Xe=e=>Qr().has(e),Ke=e=>Gn(Lt?process.env[e.toUpperCase()]:Wn.getItem(e));(e=>Xe("--"+e)||Ke(e)!==null)("production");const qn=Lt&&Kr({}.FORCE_COLOR,["true","1","2"]),Zr=!Xe("no-colors")&&(!Lt||process.stdout.isTTY||qn)&&(!Lt||Xe("color")||qn||Ke("COLORTERM")!==null||(Ke("TERM")||"").includes("color")),Xn=e=>new Uint8Array(e),ti=(e,t,n)=>new Uint8Array(e,t,n),ei=e=>new Uint8Array(e),ni=e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=mr(e[n]);return btoa(t)},si=e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),ri=e=>{const t=atob(e),n=Xn(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n},ii=e=>{const t=Buffer.from(e,"base64");return ti(t.buffer,t.byteOffset,t.byteLength)},oi=Yn?ni:si,ci=Yn?ri:ii,li=e=>{const t=Xn(e.byteLength);return t.set(e),t};class ai{constructor(t,n){this.left=t,this.right=n}}const it=(e,t)=>new ai(e,t),Ct=typeof document!="undefined"?document:{};typeof DOMParser!="undefined"&&new DOMParser;const hi=e=>ur(e,(t,n)=>`${n}:${t};`).join("");Ct.ELEMENT_NODE,Ct.TEXT_NODE,Ct.CDATA_SECTION_NODE,Ct.COMMENT_NODE,Ct.DOCUMENT_NODE,Ct.DOCUMENT_TYPE_NODE,Ct.DOCUMENT_FRAGMENT_NODE;const ot=Symbol,Kn=ot(),Qn=ot(),ui=ot(),di=ot(),fi=ot(),Zn=ot(),gi=ot(),ts=ot(),pi=ot(),wi=e=>{const t=[];let n=0;for(;n<e.length;n++){const s=e[n];s.constructor===String||s.constructor===Number||s.constructor===Object&&t.push(JSON.stringify(s))}return t},mi={[Kn]:it("font-weight","bold"),[Qn]:it("font-weight","normal"),[ui]:it("color","blue"),[fi]:it("color","green"),[di]:it("color","grey"),[Zn]:it("color","red"),[gi]:it("color","purple"),[ts]:it("color","orange"),[pi]:it("color","black")},yi=Zr?e=>{const t=[],n=[],s=T();let r=[],i=0;for(;i<e.length;i++){const o=e[i],c=mi[o];if(c!==void 0)s.set(c.left,c.right);else if(o.constructor===String||o.constructor===Number){const l=hi(s);i>0||l.length>0?(t.push("%c"+o),n.push(l)):t.push(o)}else break}for(i>0&&(r=n,r.unshift(t.join("")));i<e.length;i++){const o=e[i];o instanceof Symbol||r.push(o)}return r}:wi,bi=(...e)=>{console.log(...yi(e)),Si.forEach(t=>t.print(e))},Si=bt(),es=e=>({[Symbol.iterator](){return this},next:e}),ki=(e,t)=>es(()=>{let n;do n=e.next();while(!n.done&&!t(n.value));return n}),Qe=(e,t)=>es(()=>{const{done:n,value:s}=e.next();return{done:n,value:n?void 0:t(s)}});class Ze{constructor(t,n){this.clock=t,this.len=n}}class Kt{constructor(){this.clients=new Map}}const ns=(e,t,n)=>t.clients.forEach((s,r)=>{const i=e.doc.store.clients.get(r);for(let o=0;o<s.length;o++){const c=s[o];ks(e,i,c.clock,c.len,n)}}),_i=(e,t)=>{let n=0,s=e.length-1;for(;n<=s;){const r=st((n+s)/2),i=e[r],o=i.clock;if(o<=t){if(t<o+i.len)return r;n=r+1}else s=r-1}return null},ss=(e,t)=>{const n=e.clients.get(t.client);return n!==void 0&&_i(n,t.clock)!==null},tn=e=>{e.clients.forEach(t=>{t.sort((r,i)=>r.clock-i.clock);let n,s;for(n=1,s=1;n<t.length;n++){const r=t[s-1],i=t[n];r.clock+r.len>=i.clock?r.len=St(r.len,i.clock+i.len-r.clock):(s<n&&(t[s]=i),s++)}t.length=s})},Ci=e=>{const t=new Kt;for(let n=0;n<e.length;n++)e[n].clients.forEach((s,r)=>{if(!t.clients.has(r)){const i=s.slice();for(let o=n+1;o<e.length;o++)fr(i,e[o].clients.get(r)||[]);t.clients.set(r,i)}});return tn(t),t},pe=(e,t,n,s)=>{nt(e.clients,t,()=>[]).push(new Ze(n,s))},rs=()=>new Kt,vi=e=>{const t=rs();return e.clients.forEach((n,s)=>{const r=[];for(let i=0;i<n.length;i++){const o=n[i];if(o.deleted){const c=o.id.clock;let l=o.length;if(i+1<n.length)for(let h=n[i+1];i+1<n.length&&h.deleted;h=n[++i+1])l+=h.length;r.push(new Ze(c,l))}}r.length>0&&t.clients.set(s,r)}),t},Tt=(e,t)=>{b(e.restEncoder,t.clients.size),ut(t.clients.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{e.resetDsCurVal(),b(e.restEncoder,n);const r=s.length;b(e.restEncoder,r);for(let i=0;i<r;i++){const o=s[i];e.writeDsClock(o.clock),e.writeDsLen(o.len)}})},en=e=>{const t=new Kt,n=v(e.restDecoder);for(let s=0;s<n;s++){e.resetDsCurVal();const r=v(e.restDecoder),i=v(e.restDecoder);if(i>0){const o=nt(t.clients,r,()=>[]);for(let c=0;c<i;c++)o.push(new Ze(e.readDsClock(),e.readDsLen()))}}return t},is=(e,t,n)=>{const s=new Kt,r=v(e.restDecoder);for(let i=0;i<r;i++){e.resetDsCurVal();const o=v(e.restDecoder),c=v(e.restDecoder),l=n.clients.get(o)||[],h=$(n,o);for(let a=0;a<c;a++){const u=e.readDsClock(),d=u+e.readDsLen();if(u<h){h<d&&pe(s,o,h,d-h);let f=Z(l,u),p=l[f];for(!p.deleted&&p.id.clock<u&&(l.splice(f+1,0,Le(t,p,u-p.id.clock)),f++);f<l.length&&(p=l[f++],p.id.clock<d);)p.deleted||(d<p.id.clock+p.length&&l.splice(f,0,Le(t,p,d-p.id.clock)),p.delete(t))}else pe(s,o,u,d-u)}}if(s.clients.size>0){const i=new vt;return b(i.restEncoder,0),Tt(i,s),i.toUint8Array()}return null},os=Pn;class Ot extends In{constructor({guid:t=$r(),collectionid:n=null,gc:s=!0,gcFilter:r=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:c=!0}={}){super();this.gc=s,this.gcFilter=r,this.clientID=os(),this.guid=t,this.collectionid=n,this.share=new Map,this.store=new ys,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.whenLoaded=Hn(h=>{this.on("load",()=>{this.isLoaded=!0,h(this)})});const l=()=>Hn(h=>{const a=u=>{(u===void 0||u===!0)&&(this.off("sync",a),h())};this.on("sync",a)});this.on("sync",h=>{h===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=h===void 0||h===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[])}),this.whenSynced=l()}load(){const t=this._item;t!==null&&!this.shouldLoad&&A(t.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(ut(this.subdocs).map(t=>t.guid))}transact(t,n=null){return A(this,t,n)}get(t,n=j){const s=nt(this.share,t,()=>{const i=new n;return i._integrate(this,null),i}),r=s.constructor;if(n!==j&&r!==n)if(r===j){const i=new n;i._map=s._map,s._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=s._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=s._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return s}getArray(t=""){return this.get(t,Nt)}getText(t=""){return this.get(t,$t)}getMap(t=""){return this.get(t,Vt)}getXmlElement(t=""){return this.get(t,Bt)}getXmlFragment(t=""){return this.get(t,Dt)}toJSON(){const t={};return this.share.forEach((n,s)=>{t[s]=n.toJSON()}),t}destroy(){ut(this.subdocs).forEach(n=>n.destroy());const t=this._item;if(t!==null){this._item=null;const n=t.content;n.doc=new Ot(xe(Ht({guid:this.guid},n.opts),{shouldLoad:!1})),n.doc._item=t,A(t.parent.doc,s=>{const r=n.doc;t.deleted||s.subdocsAdded.add(r),s.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}on(t,n){super.on(t,n)}off(t,n){super.off(t,n)}}class cs{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return v(this.restDecoder)}readDsLen(){return v(this.restDecoder)}}class ls extends cs{readLeftID(){return D(v(this.restDecoder),v(this.restDecoder))}readRightID(){return D(v(this.restDecoder),v(this.restDecoder))}readClient(){return v(this.restDecoder)}readInfo(){return Mt(this.restDecoder)}readString(){return gt(this.restDecoder)}readParentInfo(){return v(this.restDecoder)===1}readTypeRef(){return v(this.restDecoder)}readLen(){return v(this.restDecoder)}readAny(){return qt(this.restDecoder)}readBuf(){return li(H(this.restDecoder))}readJSON(){return JSON.parse(gt(this.restDecoder))}readKey(){return gt(this.restDecoder)}}class Di{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=v(this.restDecoder),this.dsCurrVal}readDsLen(){const t=v(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class xt extends Di{constructor(t){super(t);this.keys=[],v(t),this.keyClockDecoder=new ze(H(t)),this.clientDecoder=new de(H(t)),this.leftClockDecoder=new ze(H(t)),this.rightClockDecoder=new ze(H(t)),this.infoDecoder=new jn(H(t),Mt),this.stringDecoder=new Nr(H(t)),this.parentInfoDecoder=new jn(H(t),Mt),this.typeRefDecoder=new de(H(t)),this.lenDecoder=new de(H(t))}readLeftID(){return new Ut(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ut(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return qt(this.restDecoder)}readBuf(){return H(this.restDecoder)}readJSON(){return qt(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class as{constructor(){this.restEncoder=G()}toUint8Array(){return O(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){b(this.restEncoder,t)}writeDsLen(t){b(this.restEncoder,t)}}class Qt extends as{writeLeftID(t){b(this.restEncoder,t.client),b(this.restEncoder,t.clock)}writeRightID(t){b(this.restEncoder,t.client),b(this.restEncoder,t.clock)}writeClient(t){b(this.restEncoder,t)}writeInfo(t){Be(this.restEncoder,t)}writeString(t){_t(this.restEncoder,t)}writeParentInfo(t){b(this.restEncoder,t?1:0)}writeTypeRef(t){b(this.restEncoder,t)}writeLen(t){b(this.restEncoder,t)}writeAny(t){Yt(this.restEncoder,t)}writeBuf(t){x(this.restEncoder,t)}writeJSON(t){_t(this.restEncoder,JSON.stringify(t))}writeKey(t){_t(this.restEncoder,t)}}class hs{constructor(){this.restEncoder=G(),this.dsCurrVal=0}toUint8Array(){return O(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const n=t-this.dsCurrVal;this.dsCurrVal=t,b(this.restEncoder,n)}writeDsLen(t){t===0&&K(),b(this.restEncoder,t-1),this.dsCurrVal+=t}}class vt extends hs{constructor(){super();this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ge,this.clientEncoder=new he,this.leftClockEncoder=new Ge,this.rightClockEncoder=new Ge,this.infoEncoder=new Nn(Be),this.stringEncoder=new Or,this.parentInfoEncoder=new Nn(Be),this.typeRefEncoder=new he,this.lenEncoder=new he}toUint8Array(){const t=G();return b(t,0),x(t,this.keyClockEncoder.toUint8Array()),x(t,this.clientEncoder.toUint8Array()),x(t,this.leftClockEncoder.toUint8Array()),x(t,this.rightClockEncoder.toUint8Array()),x(t,O(this.infoEncoder)),x(t,this.stringEncoder.toUint8Array()),x(t,O(this.parentInfoEncoder)),x(t,this.typeRefEncoder.toUint8Array()),x(t,this.lenEncoder.toUint8Array()),ae(t,O(this.restEncoder)),O(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){Yt(this.restEncoder,t)}writeBuf(t){x(this.restEncoder,t)}writeJSON(t){Yt(this.restEncoder,t)}writeKey(t){const n=this.keyMap.get(t);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(n)}}const Ei=(e,t,n,s)=>{s=St(s,t[0].id.clock);const r=Z(t,s);b(e.restEncoder,t.length-r),e.writeClient(n),b(e.restEncoder,s);const i=t[r];i.write(e,s-i.id.clock);for(let o=r+1;o<t.length;o++)t[o].write(e,0)},nn=(e,t,n)=>{const s=new Map;n.forEach((r,i)=>{$(t,i)>r&&s.set(i,r)}),me(t).forEach((r,i)=>{n.has(i)||s.set(i,0)}),b(e.restEncoder,s.size),ut(s.entries()).sort((r,i)=>i[0]-r[0]).forEach(([r,i])=>{Ei(e,t.clients.get(r),r,i)})},Ai=(e,t)=>{const n=T(),s=v(e.restDecoder);for(let r=0;r<s;r++){const i=v(e.restDecoder),o=new Array(i),c=e.readClient();let l=v(e.restDecoder);n.set(c,{i:0,refs:o});for(let h=0;h<i;h++){const a=e.readInfo();switch(le&a){case 0:{const u=e.readLen();o[h]=new W(D(c,l),u),l+=u;break}case 10:{const u=v(e.restDecoder);o[h]=new z(D(c,l),u),l+=u;break}default:{const u=(a&(rt|J))===0,d=new N(D(c,l),null,(a&J)===J?e.readLeftID():null,null,(a&rt)===rt?e.readRightID():null,u?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,u&&(a&Gt)===Gt?e.readString():null,Ws(e,a));o[h]=d,l+=d.length}}}}return n},Ii=(e,t,n)=>{const s=[];let r=ut(n.keys()).sort((f,p)=>f-p);if(r.length===0)return null;const i=()=>{if(r.length===0)return null;let f=n.get(r[r.length-1]);for(;f.refs.length===f.i;)if(r.pop(),r.length>0)f=n.get(r[r.length-1]);else return null;return f};let o=i();if(o===null)return null;const c=new ys,l=new Map,h=(f,p)=>{const S=l.get(f);(S==null||S>p)&&l.set(f,p)};let a=o.refs[o.i++];const u=new Map,d=()=>{for(const f of s){const p=f.id.client,S=n.get(p);S?(S.i--,c.clients.set(p,S.refs.slice(S.i)),n.delete(p),S.i=0,S.refs=[]):c.clients.set(p,[f]),r=r.filter(I=>I!==p)}s.length=0};for(;;){if(a.constructor!==z){const p=nt(u,a.id.client,()=>$(t,a.id.client))-a.id.clock;if(p<0)s.push(a),h(a.id.client,a.id.clock-1),d();else{const S=a.getMissing(e,t);if(S!==null){s.push(a);const I=n.get(S)||{refs:[],i:0};if(I.refs.length===I.i)h(S,$(t,S)),d();else{a=I.refs[I.i++];continue}}else(p===0||p<a.length)&&(a.integrate(e,p),u.set(a.id.client,a.id.clock+a.length))}}if(s.length>0)a=s.pop();else if(o!==null&&o.i<o.refs.length)a=o.refs[o.i++];else{if(o=i(),o===null)break;a=o.refs[o.i++]}}if(c.clients.size>0){const f=new vt;return nn(f,c,new Map),b(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},Mi=(e,t)=>nn(e,t.doc.store,t.beforeState),Li=(e,t,n,s=new xt(e))=>A(t,r=>{r.local=!1;let i=!1;const o=r.doc,c=o.store,l=Ai(s,o),h=Ii(r,c,l),a=c.pendingStructs;if(a){for(const[d,f]of a.missing)if(f<$(c,d)){i=!0;break}if(h){for(const[d,f]of h.missing){const p=a.missing.get(d);(p==null||p>f)&&a.missing.set(d,f)}a.update=be([a.update,h.update])}}else c.pendingStructs=h;const u=is(s,r,c);if(c.pendingDs){const d=new xt(ft(c.pendingDs));v(d.restDecoder);const f=is(d,r,c);u&&f?c.pendingDs=be([u,f]):c.pendingDs=u||f}else c.pendingDs=u;if(i){const d=c.pendingStructs.update;c.pendingStructs=null,us(r.doc,d)}},n,!1),us=(e,t,n,s=xt)=>{const r=ft(t);Li(r,e,n,new s(r))},Ti=(e,t,n)=>us(e,t,n,ls),Oi=(e,t,n=new Map)=>{nn(e,t.store,n),Tt(e,vi(t.store))},xi=(e,t=new Uint8Array([0]),n=new vt)=>{const s=ds(t);Oi(n,e,s);const r=[n.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(qi(e.store.pendingStructs.update,t)),r.length>1){if(n.constructor===Qt)return zi(r.map((i,o)=>o===0?i:Ki(i)));if(n.constructor===vt)return be(r)}return r[0]},Ui=(e,t)=>xi(e,t,new Qt),Ri=e=>{const t=new Map,n=v(e.restDecoder);for(let s=0;s<n;s++){const r=v(e.restDecoder),i=v(e.restDecoder);t.set(r,i)}return t},ds=e=>Ri(new cs(ft(e))),fs=(e,t)=>(b(e.restEncoder,t.size),ut(t.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{b(e.restEncoder,n),b(e.restEncoder,s)}),e),Ni=(e,t)=>fs(e,me(t.store)),Vi=(e,t=new hs)=>(e instanceof Map?fs(t,e):Ni(t,e),t.toUint8Array()),Fi=e=>Vi(e,new as);class $i{constructor(){this.l=[]}}const gs=()=>new $i,ps=(e,t)=>e.l.push(t),ws=(e,t)=>{const n=e.l,s=n.length;e.l=n.filter(r=>t!==r),s===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},ms=(e,t,n)=>qe(e.l,[t,n]);class Ut{constructor(t,n){this.client=t,this.clock=n}}const we=(e,t)=>e===t||e!==null&&t!==null&&e.client===t.client&&e.clock===t.clock,D=(e,t)=>new Ut(e,t),Bi=e=>{for(const[t,n]of e.doc.share.entries())if(n===e)return t;throw K()};class ji{constructor(t,n){this.ds=t,this.sv=n}}((e,t)=>new ji(e,t))(rs(),new Map);const Rt=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!ss(t.ds,e.id),sn=(e,t)=>{const n=nt(e.meta,sn,bt),s=e.doc.store;n.has(t)||(t.sv.forEach((r,i)=>{r<$(s,i)&&pt(e,D(i,r))}),ns(e,t.ds,r=>{}),n.add(t))};class ys{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const me=e=>{const t=new Map;return e.clients.forEach((n,s)=>{const r=n[n.length-1];t.set(s,r.id.clock+r.length)}),t},$=(e,t)=>{const n=e.clients.get(t);if(n===void 0)return 0;const s=n[n.length-1];return s.id.clock+s.length},bs=(e,t)=>{let n=e.clients.get(t.id.client);if(n===void 0)n=[],e.clients.set(t.id.client,n);else{const s=n[n.length-1];if(s.id.clock+s.length!==t.id.clock)throw K()}n.push(t)},Z=(e,t)=>{let n=0,s=e.length-1,r=e[s],i=r.id.clock;if(i===t)return s;let o=st(t/(i+r.length-1)*s);for(;n<=s;){if(r=e[o],i=r.id.clock,i<=t){if(t<i+r.length)return o;n=o+1}else s=o-1;o=st((n+s)/2)}throw K()},rn=(e,t)=>{const n=e.clients.get(t.client);return n[Z(n,t.clock)]},on=(e,t,n)=>{const s=Z(t,n),r=t[s];return r.id.clock<n&&r instanceof N?(t.splice(s+1,0,Le(e,r,n-r.id.clock)),s+1):s},pt=(e,t)=>{const n=e.doc.store.clients.get(t.client);return n[on(e,n,t.clock)]},Ss=(e,t,n)=>{const s=t.clients.get(n.client),r=Z(s,n.clock),i=s[r];return n.clock!==i.id.clock+i.length-1&&i.constructor!==W&&s.splice(r+1,0,Le(e,i,n.clock-i.id.clock+1)),i},Pi=(e,t,n)=>{const s=e.clients.get(t.id.client);s[Z(s,t.id.clock)]=n},ks=(e,t,n,s,r)=>{if(s===0)return;const i=n+s;let o=on(e,t,n),c;do c=t[o++],i<c.id.clock+c.length&&on(e,t,i),r(c);while(o<t.length&&t[o].id.clock<i)};class Hi{constructor(t,n,s){this.doc=t,this.deleteSet=new Kt,this.beforeState=me(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=s,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const _s=(e,t)=>t.deleteSet.clients.size===0&&!dr(t.afterState,(n,s)=>t.beforeState.get(s)!==n)?!1:(tn(t.deleteSet),Mi(e,t),Tt(e,t.deleteSet),!0),Cs=(e,t,n)=>{const s=t._item;(s===null||s.id.clock<(e.beforeState.get(s.id.client)||0)&&!s.deleted)&&nt(e.changed,t,bt).add(n)},ye=(e,t)=>{let n=e[t],s=e[t-1],r=t;for(;r>0;n=s,s=e[--r-1]){if(s.deleted===n.deleted&&s.constructor===n.constructor&&s.mergeWith(n)){n instanceof N&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,s);continue}break}const i=t-r;return i&&e.splice(t+1-i,i),i},Gi=(e,t,n)=>{for(const[s,r]of e.clients.entries()){const i=t.clients.get(s);for(let o=r.length-1;o>=0;o--){const c=r[o],l=c.clock+c.len;for(let h=Z(i,c.clock),a=i[h];h<i.length&&a.id.clock<l;a=i[++h]){const u=i[h];if(c.clock+c.len<=u.id.clock)break;u instanceof N&&u.deleted&&!u.keep&&n(u)&&u.gc(t,!1)}}}},Ji=(e,t)=>{e.clients.forEach((n,s)=>{const r=t.clients.get(s);for(let i=n.length-1;i>=0;i--){const o=n[i],c=Mn(r.length-1,1+Z(r,o.clock+o.len-1));for(let l=c,h=r[l];l>0&&h.id.clock>=o.clock;h=r[l])l-=1+ye(r,l)}})},vs=(e,t)=>{if(t<e.length){const n=e[t],s=n.doc,r=s.store,i=n.deleteSet,o=n._mergeStructs;try{tn(i),n.afterState=me(n.doc.store),s.emit("beforeObserverCalls",[n,s]);const c=[];n.changed.forEach((l,h)=>c.push(()=>{(h._item===null||!h._item.deleted)&&h._callObserver(n,l)})),c.push(()=>{n.changedParentTypes.forEach((l,h)=>{h._dEH.l.length>0&&(h._item===null||!h._item.deleted)&&(l=l.filter(a=>a.target._item===null||!a.target._item.deleted),l.forEach(a=>{a.currentTarget=h,a._path=null}),l.sort((a,u)=>a.path.length-u.path.length),ms(h._dEH,l,n))})}),c.push(()=>s.emit("afterTransaction",[n,s])),qe(c,[]),n._needFormattingCleanup&&uo(n)}finally{s.gc&&Gi(i,r,s.gcFilter),Ji(i,r),n.afterState.forEach((a,u)=>{const d=n.beforeState.get(u)||0;if(d!==a){const f=r.clients.get(u),p=St(Z(f,d),1);for(let S=f.length-1;S>=p;)S-=1+ye(f,S)}});for(let a=o.length-1;a>=0;a--){const{client:u,clock:d}=o[a].id,f=r.clients.get(u),p=Z(f,d);p+1<f.length&&ye(f,p+1)>1||p>0&&ye(f,p)}if(!n.local&&n.afterState.get(s.clientID)!==n.beforeState.get(s.clientID)&&(bi(ts,Kn,"[yjs] ",Qn,Zn,"Changed the client-id because another client seems to be using it."),s.clientID=os()),s.emit("afterTransactionCleanup",[n,s]),s._observers.has("update")){const a=new Qt;_s(a,n)&&s.emit("update",[a.toUint8Array(),n.origin,s,n])}if(s._observers.has("updateV2")){const a=new vt;_s(a,n)&&s.emit("updateV2",[a.toUint8Array(),n.origin,s,n])}const{subdocsAdded:c,subdocsLoaded:l,subdocsRemoved:h}=n;(c.size>0||h.size>0||l.size>0)&&(c.forEach(a=>{a.clientID=s.clientID,a.collectionid==null&&(a.collectionid=s.collectionid),s.subdocs.add(a)}),h.forEach(a=>s.subdocs.delete(a)),s.emit("subdocs",[{loaded:l,added:c,removed:h},s,n]),h.forEach(a=>a.destroy())),e.length<=t+1?(s._transactionCleanups=[],s.emit("afterAllTransactions",[s,e])):vs(e,t+1)}}},A=(e,t,n=null,s=!0)=>{const r=e._transactionCleanups;let i=!1,o=null;e._transaction===null&&(i=!0,e._transaction=new Hi(e,n,s),r.push(e._transaction),r.length===1&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{o=t(e._transaction)}finally{if(i){const c=e._transaction===r[0];e._transaction=null,c&&vs(r,0)}}return o};function*Wi(e){const t=v(e.restDecoder);for(let n=0;n<t;n++){const s=v(e.restDecoder),r=e.readClient();let i=v(e.restDecoder);for(let o=0;o<s;o++){const c=e.readInfo();if(c===10){const l=v(e.restDecoder);yield new z(D(r,i),l),i+=l}else if((le&c)!==0){const l=(c&(rt|J))===0,h=new N(D(r,i),null,(c&J)===J?e.readLeftID():null,null,(c&rt)===rt?e.readRightID():null,l?e.readParentInfo()?e.readString():e.readLeftID():null,l&&(c&Gt)===Gt?e.readString():null,Ws(e,c));yield h,i+=h.length}else{const l=e.readLen();yield new W(D(r,i),l),i+=l}}}}class cn{constructor(t,n){this.gen=Wi(t),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===z);return this.curr}}class ln{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const zi=e=>be(e,ls,Qt),Yi=(e,t)=>{if(e.constructor===W){const{client:n,clock:s}=e.id;return new W(D(n,s+t),e.length-t)}else if(e.constructor===z){const{client:n,clock:s}=e.id;return new z(D(n,s+t),e.length-t)}else{const n=e,{client:s,clock:r}=n.id;return new N(D(s,r+t),null,D(s,r+t-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(t))}},be=(e,t=xt,n=vt)=>{if(e.length===1)return e[0];const s=e.map(a=>new t(ft(a)));let r=s.map(a=>new cn(a,!0)),i=null;const o=new n,c=new ln(o);for(;r=r.filter(d=>d.curr!==null),r.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){const p=d.curr.id.clock-f.curr.id.clock;return p===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===z?1:-1:p}else return f.curr.id.client-d.curr.id.client}),r.length!==0;){const a=r[0],u=a.curr.id.client;if(i!==null){let d=a.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=a.next(),f=!0;if(d===null||d.id.client!==u||f&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(u!==i.struct.id.client)wt(c,i.struct,i.offset),i={struct:d,offset:0},a.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===z)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{wt(c,i.struct,i.offset);const p=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new z(D(u,i.struct.id.clock+i.struct.length),p),offset:0}}else{const p=i.struct.id.clock+i.struct.length-d.id.clock;p>0&&(i.struct.constructor===z?i.struct.length-=p:d=Yi(d,p)),i.struct.mergeWith(d)||(wt(c,i.struct,i.offset),i={struct:d,offset:0},a.next())}}else i={struct:a.curr,offset:0},a.next();for(let d=a.curr;d!==null&&d.id.client===u&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==z;d=a.next())wt(c,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(wt(c,i.struct,i.offset),i=null),an(c);const l=s.map(a=>en(a)),h=Ci(l);return Tt(o,h),o.toUint8Array()},qi=(e,t,n=xt,s=vt)=>{const r=ds(t),i=new s,o=new ln(i),c=new n(ft(e)),l=new cn(c,!1);for(;l.curr;){const a=l.curr,u=a.id.client,d=r.get(u)||0;if(l.curr.constructor===z){l.next();continue}if(a.id.clock+a.length>d)for(wt(o,a,St(d-a.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)wt(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=d;)l.next()}an(o);const h=en(c);return Tt(i,h),i.toUint8Array()},Ds=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:O(e.encoder.restEncoder)}),e.encoder.restEncoder=G(),e.written=0)},wt=(e,t,n)=>{e.written>0&&e.currClient!==t.id.client&&Ds(e),e.written===0&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),b(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},an=e=>{Ds(e);const t=e.encoder.restEncoder;b(t,e.clientStructs.length);for(let n=0;n<e.clientStructs.length;n++){const s=e.clientStructs[n];b(t,s.written),ae(t,s.restEncoder)}},Xi=(e,t,n,s)=>{const r=new n(ft(e)),i=new cn(r,!1),o=new s,c=new ln(o);for(let h=i.curr;h!==null;h=i.next())wt(c,t(h),0);an(c);const l=en(r);return Tt(o,l),o.toUint8Array()},Ki=e=>Xi(e,qr,xt,Qt),Es="You must not compute changes after the event-handler fired.";class Se{constructor(t,n){this.target=t,this.currentTarget=t,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=Qi(this.currentTarget,this.target))}deletes(t){return ss(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw dt(Es);const t=new Map,n=this.target;this.transaction.changed.get(n).forEach(r=>{if(r!==null){const i=n._map.get(r);let o,c;if(this.adds(i)){let l=i.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(i))if(l!==null&&this.deletes(l))o="delete",c=Re(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",c=Re(l.content.getContent())):(o="add",c=void 0)}else if(this.deletes(i))o="delete",c=Re(i.content.getContent());else return;t.set(r,{action:o,oldValue:c})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw dt(Es);const n=this.target,s=bt(),r=bt(),i=[];if(t={added:s,deleted:r,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let c=null;const l=()=>{c&&i.push(c)};for(let h=n._start;h!==null;h=h.right)h.deleted?this.deletes(h)&&!this.adds(h)&&((c===null||c.delete===void 0)&&(l(),c={delete:0}),c.delete+=h.length,r.add(h)):this.adds(h)?((c===null||c.insert===void 0)&&(l(),c={insert:[]}),c.insert=c.insert.concat(h.content.getContent()),s.add(h)):((c===null||c.retain===void 0)&&(l(),c={retain:0}),c.retain+=h.length);c!==null&&c.retain===void 0&&l()}this._changes=t}return t}}const Qi=(e,t)=>{const n=[];for(;t._item!==null&&t!==e;){if(t._item.parentSub!==null)n.unshift(t._item.parentSub);else{let s=0,r=t._item.parent._start;for(;r!==t._item&&r!==null;)r.deleted||s++,r=r.right;n.unshift(s)}t=t._item.parent}return n},As=80;let hn=0;class Zi{constructor(t,n){t.marker=!0,this.p=t,this.index=n,this.timestamp=hn++}}const to=e=>{e.timestamp=hn++},Is=(e,t,n)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=hn++},eo=(e,t,n)=>{if(e.length>=As){const s=e.reduce((r,i)=>r.timestamp<i.timestamp?r:i);return Is(s,t,n),s}else{const s=new Zi(t,n);return e.push(s),s}},ke=(e,t)=>{if(e._start===null||t===0||e._searchMarker===null)return null;const n=e._searchMarker.length===0?null:e._searchMarker.reduce((i,o)=>ce(t-i.index)<ce(t-o.index)?i:o);let s=e._start,r=0;for(n!==null&&(s=n.p,r=n.index,to(n));s.right!==null&&r<t;){if(!s.deleted&&s.countable){if(t<r+s.length)break;r+=s.length}s=s.right}for(;s.left!==null&&r>t;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);for(;s.left!==null&&s.left.id.client===s.id.client&&s.left.id.clock+s.left.length===s.id.clock;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);return n!==null&&ce(n.index-r)<s.parent.length/As?(Is(n,s,r),n):eo(e._searchMarker,s,r)},Zt=(e,t,n)=>{for(let s=e.length-1;s>=0;s--){const r=e[s];if(n>0){let i=r.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(r.index-=i.length);if(i===null||i.marker===!0){e.splice(s,1);continue}r.p=i,i.marker=!0}(t<r.index||n>0&&t===r.index)&&(r.index=St(t,r.index+n))}},_e=(e,t,n)=>{const s=e,r=t.changedParentTypes;for(;nt(r,e,()=>[]).push(n),e._item!==null;)e=e._item.parent;ms(s._eH,n,t)};class j{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=gs(),this._dEH=gs(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,n){this.doc=t,this._item=n}_copy(){throw X()}clone(){throw X()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,n){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){ps(this._eH,t)}observeDeep(t){ps(this._dEH,t)}unobserve(t){ws(this._eH,t)}unobserveDeep(t){ws(this._dEH,t)}toJSON(){}}const Ms=(e,t,n)=>{t<0&&(t=e._length+t),n<0&&(n=e._length+n);let s=n-t;const r=[];let i=e._start;for(;i!==null&&s>0;){if(i.countable&&!i.deleted){const o=i.content.getContent();if(o.length<=t)t-=o.length;else{for(let c=t;c<o.length&&s>0;c++)r.push(o[c]),s--;t=0}}i=i.right}return r},Ls=e=>{const t=[];let n=e._start;for(;n!==null;){if(n.countable&&!n.deleted){const s=n.content.getContent();for(let r=0;r<s.length;r++)t.push(s[r])}n=n.right}return t},te=(e,t)=>{let n=0,s=e._start;for(;s!==null;){if(s.countable&&!s.deleted){const r=s.content.getContent();for(let i=0;i<r.length;i++)t(r[i],n++,e)}s=s.right}},Ts=(e,t)=>{const n=[];return te(e,(s,r)=>{n.push(t(s,r,e))}),n},no=e=>{let t=e._start,n=null,s=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};n=t.content.getContent(),s=0,t=t.right}const r=n[s++];return n.length<=s&&(n=null),{done:!1,value:r}}}},Os=(e,t)=>{const n=ke(e,t);let s=e._start;for(n!==null&&(s=n.p,t-=n.index);s!==null;s=s.right)if(!s.deleted&&s.countable){if(t<s.length)return s.content.getContent()[t];t-=s.length}},Ce=(e,t,n,s)=>{let r=n;const i=e.doc,o=i.clientID,c=i.store,l=n===null?t._start:n.right;let h=[];const a=()=>{h.length>0&&(r=new N(D(o,$(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new At(h)),r.integrate(e,0),h=[])};s.forEach(u=>{if(u===null)h.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:h.push(u);break;default:switch(a(),u.constructor){case Uint8Array:case ArrayBuffer:r=new N(D(o,$(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new ee(new Uint8Array(u))),r.integrate(e,0);break;case Ot:r=new N(D(o,$(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new se(u)),r.integrate(e,0);break;default:if(u instanceof j)r=new N(D(o,$(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new ct(u)),r.integrate(e,0);else throw new Error("Unexpected content type in insert operation")}}}),a()},xs=()=>dt("Length exceeded!"),Us=(e,t,n,s)=>{if(n>t._length)throw xs();if(n===0)return t._searchMarker&&Zt(t._searchMarker,n,s.length),Ce(e,t,null,s);const r=n,i=ke(t,n);let o=t._start;for(i!==null&&(o=i.p,n-=i.index,n===0&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&pt(e,D(o.id.client,o.id.clock+n));break}n-=o.length}return t._searchMarker&&Zt(t._searchMarker,r,s.length),Ce(e,t,o,s)},so=(e,t,n)=>{let r=(t._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;return Ce(e,t,r,n)},Rs=(e,t,n,s)=>{if(s===0)return;const r=n,i=s,o=ke(t,n);let c=t._start;for(o!==null&&(c=o.p,n-=o.index);c!==null&&n>0;c=c.right)!c.deleted&&c.countable&&(n<c.length&&pt(e,D(c.id.client,c.id.clock+n)),n-=c.length);for(;s>0&&c!==null;)c.deleted||(s<c.length&&pt(e,D(c.id.client,c.id.clock+s)),c.delete(e),s-=c.length),c=c.right;if(s>0)throw xs();t._searchMarker&&Zt(t._searchMarker,r,-i+s)},ve=(e,t,n)=>{const s=t._map.get(n);s!==void 0&&s.delete(e)},un=(e,t,n,s)=>{const r=t._map.get(n)||null,i=e.doc,o=i.clientID;let c;if(s==null)c=new At([s]);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:c=new At([s]);break;case Uint8Array:c=new ee(s);break;case Ot:c=new se(s);break;default:if(s instanceof j)c=new ct(s);else throw new Error("Unexpected content type")}new N(D(o,$(i.store,o)),r,r&&r.lastId,null,null,t,n,c).integrate(e,0)},dn=(e,t)=>{const n=e._map.get(t);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},Ns=e=>{const t={};return e._map.forEach((n,s)=>{n.deleted||(t[s]=n.content.getContent()[n.length-1])}),t},Vs=(e,t)=>{const n=e._map.get(t);return n!==void 0&&!n.deleted},ro=(e,t)=>{const n={};return e._map.forEach((s,r)=>{let i=s;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;i!==null&&Rt(i,t)&&(n[r]=i.content.getContent()[i.length-1])}),n},De=e=>ki(e.entries(),t=>!t[1].deleted);class io extends Se{constructor(t,n){super(t,n);this._transaction=n}}class Nt extends j{constructor(){super();this._prelimContent=[],this._searchMarker=[]}static from(t){const n=new Nt;return n.push(t),n}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Nt}clone(){const t=new Nt;return t.insert(0,this.toArray().map(n=>n instanceof j?n.clone():n)),t}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}_callObserver(t,n){super._callObserver(t,n),_e(this,t,new io(this,t))}insert(t,n){this.doc!==null?A(this.doc,s=>{Us(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}push(t){this.doc!==null?A(this.doc,n=>{so(n,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,n=1){this.doc!==null?A(this.doc,s=>{Rs(s,this,t,n)}):this._prelimContent.splice(t,n)}get(t){return Os(this,t)}toArray(){return Ls(this)}slice(t=0,n=this.length){return Ms(this,t,n)}toJSON(){return this.map(t=>t instanceof j?t.toJSON():t)}map(t){return Ts(this,t)}forEach(t){te(this,t)}[Symbol.iterator](){return no(this)}_write(t){t.writeTypeRef(Lo)}}const oo=e=>new Nt;class co extends Se{constructor(t,n,s){super(t,n);this.keysChanged=s}}class Vt extends j{constructor(t){super();this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,n){super._integrate(t,n),this._prelimContent.forEach((s,r)=>{this.set(r,s)}),this._prelimContent=null}_copy(){return new Vt}clone(){const t=new Vt;return this.forEach((n,s)=>{t.set(s,n instanceof j?n.clone():n)}),t}_callObserver(t,n){_e(this,t,new co(this,t,n))}toJSON(){const t={};return this._map.forEach((n,s)=>{if(!n.deleted){const r=n.content.getContent()[n.length-1];t[s]=r instanceof j?r.toJSON():r}}),t}get size(){return[...De(this._map)].length}keys(){return Qe(De(this._map),t=>t[0])}values(){return Qe(De(this._map),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Qe(De(this._map),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this._map.forEach((n,s)=>{n.deleted||t(n.content.getContent()[n.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?A(this.doc,n=>{ve(n,this,t)}):this._prelimContent.delete(t)}set(t,n){return this.doc!==null?A(this.doc,s=>{un(s,this,t,n)}):this._prelimContent.set(t,n),n}get(t){return dn(this,t)}has(t){return Vs(this,t)}clear(){this.doc!==null?A(this.doc,t=>{this.forEach(function(n,s,r){ve(t,r,s)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(To)}}const lo=e=>new Vt,mt=(e,t)=>e===t||typeof e=="object"&&typeof t=="object"&&e&&t&&Yr(e,t);class fn{constructor(t,n,s,r){this.left=t,this.right=n,this.index=s,this.currentAttributes=r}forward(){switch(this.right===null&&K(),this.right.content.constructor){case R:this.right.deleted||Ft(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const Fs=(e,t,n)=>{for(;t.right!==null&&n>0;){switch(t.right.content.constructor){case R:t.right.deleted||Ft(t.currentAttributes,t.right.content);break;default:t.right.deleted||(n<t.right.length&&pt(e,D(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},Ee=(e,t,n,s)=>{const r=new Map,i=s?ke(t,n):null;if(i){const o=new fn(i.p.left,i.p,i.index,r);return Fs(e,o,n-i.index)}else{const o=new fn(null,t._start,0,r);return Fs(e,o,n)}},$s=(e,t,n,s)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===R&&mt(s.get(n.right.content.key),n.right.content.value));)n.right.deleted||s.delete(n.right.content.key),n.forward();const r=e.doc,i=r.clientID;s.forEach((o,c)=>{const l=n.left,h=n.right,a=new N(D(i,$(r.store,i)),l,l&&l.lastId,h,h&&h.id,t,null,new R(c,o));a.integrate(e,0),n.right=a,n.forward()})},Ft=(e,t)=>{const{key:n,value:s}=t;s===null?e.delete(n):e.set(n,s)},Bs=(e,t)=>{for(;e.right!==null;){if(!(e.right.deleted||e.right.content.constructor===R&&mt(t[e.right.content.key]||null,e.right.content.value)))break;e.forward()}},js=(e,t,n,s)=>{const r=e.doc,i=r.clientID,o=new Map;for(const c in s){const l=s[c],h=n.currentAttributes.get(c)||null;if(!mt(h,l)){o.set(c,h);const{left:a,right:u}=n;n.right=new N(D(i,$(r.store,i)),a,a&&a.lastId,u,u&&u.id,t,null,new R(c,l)),n.right.integrate(e,0),n.forward()}}return o},gn=(e,t,n,s,r)=>{n.currentAttributes.forEach((d,f)=>{r[f]===void 0&&(r[f]=null)});const i=e.doc,o=i.clientID;Bs(n,r);const c=js(e,t,n,r),l=s.constructor===String?new tt(s):s instanceof j?new ct(s):new Et(s);let{left:h,right:a,index:u}=n;t._searchMarker&&Zt(t._searchMarker,n.index,l.getLength()),a=new N(D(o,$(i.store,o)),h,h&&h.lastId,a,a&&a.id,t,null,l),a.integrate(e,0),n.right=a,n.index=u,n.forward(),$s(e,t,n,c)},Ps=(e,t,n,s,r)=>{const i=e.doc,o=i.clientID;Bs(n,r);const c=js(e,t,n,r);t:for(;n.right!==null&&(s>0||c.size>0&&(n.right.deleted||n.right.content.constructor===R));){if(!n.right.deleted)switch(n.right.content.constructor){case R:{const{key:l,value:h}=n.right.content,a=r[l];if(a!==void 0){if(mt(a,h))c.delete(l);else{if(s===0)break t;c.set(l,h)}n.right.delete(e)}else n.currentAttributes.set(l,h);break}default:s<n.right.length&&pt(e,D(n.right.id.client,n.right.id.clock+s)),s-=n.right.length;break}n.forward()}if(s>0){let l="";for(;s>0;s--)l+=`
`;n.right=new N(D(o,$(i.store,o)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new tt(l)),n.right.integrate(e,0),n.forward()}$s(e,t,n,c)},Hs=(e,t,n,s,r)=>{let i=t;const o=T();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===R){const h=i.content;o.set(h.key,h)}i=i.right}let c=0,l=!1;for(;t!==i;){if(n===t&&(l=!0),!t.deleted){const h=t.content;switch(h.constructor){case R:{const{key:a,value:u}=h,d=s.get(a)||null;(o.get(a)!==h||d===u)&&(t.delete(e),c++,!l&&(r.get(a)||null)===u&&d!==u&&(d===null?r.delete(a):r.set(a,d))),!l&&!t.deleted&&Ft(r,h);break}}}t=t.right}return c},ao=(e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const n=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===R){const s=t.content.key;n.has(s)?t.delete(e):n.add(s)}t=t.left}},ho=e=>{let t=0;return A(e.doc,n=>{let s=e._start,r=e._start,i=T();const o=Ue(i);for(;r;){if(r.deleted===!1)switch(r.content.constructor){case R:Ft(o,r.content);break;default:t+=Hs(n,s,r,i,o),i=Ue(o),s=r;break}r=r.right}}),t},uo=e=>{const t=new Set,n=e.doc;for(const[s,r]of e.afterState.entries()){const i=e.beforeState.get(s)||0;r!==i&&ks(e,n.store.clients.get(s),i,r,o=>{!o.deleted&&o.content.constructor===R&&o.constructor!==W&&t.add(o.parent)})}A(n,s=>{ns(e,e.deleteSet,r=>{if(r instanceof W||!r.parent._hasFormatting||t.has(r.parent))return;const i=r.parent;r.content.constructor===R?t.add(i):ao(s,r)});for(const r of t)ho(r)})},Gs=(e,t,n)=>{const s=n,r=Ue(t.currentAttributes),i=t.right;for(;n>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case ct:case Et:case tt:n<t.right.length&&pt(e,D(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e);break}t.forward()}i&&Hs(e,i,t.right,r,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&Zt(o._searchMarker,t.index,-s+n),t};class fo extends Se{constructor(t,n,s){super(t,n);this.childListChanged=!1,this.keysChanged=new Set,s.forEach(r=>{r===null?this.childListChanged=!0:this.keysChanged.add(r)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,n=[];A(t,s=>{const r=new Map,i=new Map;let o=this.target._start,c=null;const l={};let h="",a=0,u=0;const d=()=>{if(c!==null){let f=null;switch(c){case"delete":u>0&&(f={delete:u}),u=0;break;case"insert":(typeof h=="object"||h.length>0)&&(f={insert:h},r.size>0&&(f.attributes={},r.forEach((p,S)=>{p!==null&&(f.attributes[S]=p)}))),h="";break;case"retain":a>0&&(f={retain:a},Wr(l)||(f.attributes=Hr({},l))),a=0;break}f&&n.push(f),c=null}};for(;o!==null;){switch(o.content.constructor){case ct:case Et:this.adds(o)?this.deletes(o)||(d(),c="insert",h=o.content.getContent()[0],d()):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=1):o.deleted||(c!=="retain"&&(d(),c="retain"),a+=1);break;case tt:this.adds(o)?this.deletes(o)||(c!=="insert"&&(d(),c="insert"),h+=o.content.str):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=o.length):o.deleted||(c!=="retain"&&(d(),c="retain"),a+=o.length);break;case R:{const{key:f,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){const S=r.get(f)||null;mt(S,p)?p!==null&&o.delete(s):(c==="retain"&&d(),mt(p,i.get(f)||null)?delete l[f]:l[f]=p)}}else if(this.deletes(o)){i.set(f,p);const S=r.get(f)||null;mt(S,p)||(c==="retain"&&d(),l[f]=S)}else if(!o.deleted){i.set(f,p);const S=l[f];S!==void 0&&(mt(S,p)?S!==null&&o.delete(s):(c==="retain"&&d(),p===null?delete l[f]:l[f]=p))}o.deleted||(c==="insert"&&d(),Ft(r,o.content));break}}o=o.right}for(d();n.length>0;){const f=n[n.length-1];if(f.retain!==void 0&&f.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class $t extends j{constructor(t){super();this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this._length}_integrate(t,n){super._integrate(t,n);try{this._pending.forEach(s=>s())}catch(s){console.error(s)}this._pending=null}_copy(){return new $t}clone(){const t=new $t;return t.applyDelta(this.toDelta()),t}_callObserver(t,n){super._callObserver(t,n);const s=new fo(this,t,n);_e(this,t,s),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){let t="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===tt&&(t+=n.content.str),n=n.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:n=!0}={}){this.doc!==null?A(this.doc,s=>{const r=new fn(null,this._start,0,new Map);for(let i=0;i<t.length;i++){const o=t[i];if(o.insert!==void 0){const c=!n&&typeof o.insert=="string"&&i===t.length-1&&r.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof c!="string"||c.length>0)&&gn(s,this,r,c,o.attributes||{})}else o.retain!==void 0?Ps(s,this,r,o.retain,o.attributes||{}):o.delete!==void 0&&Gs(s,r,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,n,s){const r=[],i=new Map,o=this.doc;let c="",l=this._start;function h(){if(c.length>0){const u={};let d=!1;i.forEach((p,S)=>{d=!0,u[S]=p});const f={insert:c};d&&(f.attributes=u),r.push(f),c=""}}const a=()=>{for(;l!==null;){if(Rt(l,t)||n!==void 0&&Rt(l,n))switch(l.content.constructor){case tt:{const u=i.get("ychange");t!==void 0&&!Rt(l,t)?(u===void 0||u.user!==l.id.client||u.type!=="removed")&&(h(),i.set("ychange",s?s("removed",l.id):{type:"removed"})):n!==void 0&&!Rt(l,n)?(u===void 0||u.user!==l.id.client||u.type!=="added")&&(h(),i.set("ychange",s?s("added",l.id):{type:"added"})):u!==void 0&&(h(),i.delete("ychange")),c+=l.content.str;break}case ct:case Et:{h();const u={insert:l.content.getContent()[0]};if(i.size>0){const d={};u.attributes=d,i.forEach((f,p)=>{d[p]=f})}r.push(u);break}case R:Rt(l,t)&&(h(),Ft(i,l.content));break}l=l.right}h()};return t||n?A(o,u=>{t&&sn(u,t),n&&sn(u,n),a()},"cleanup"):a(),r}insert(t,n,s){if(n.length<=0)return;const r=this.doc;r!==null?A(r,i=>{const o=Ee(i,this,t,!s);s||(s={},o.currentAttributes.forEach((c,l)=>{s[l]=c})),gn(i,this,o,n,s)}):this._pending.push(()=>this.insert(t,n,s))}insertEmbed(t,n,s){const r=this.doc;r!==null?A(r,i=>{const o=Ee(i,this,t,!s);gn(i,this,o,n,s||{})}):this._pending.push(()=>this.insertEmbed(t,n,s||{}))}delete(t,n){if(n===0)return;const s=this.doc;s!==null?A(s,r=>{Gs(r,Ee(r,this,t,!0),n)}):this._pending.push(()=>this.delete(t,n))}format(t,n,s){if(n===0)return;const r=this.doc;r!==null?A(r,i=>{const o=Ee(i,this,t,!1);o.right!==null&&Ps(i,this,o,n,s)}):this._pending.push(()=>this.format(t,n,s))}removeAttribute(t){this.doc!==null?A(this.doc,n=>{ve(n,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,n){this.doc!==null?A(this.doc,s=>{un(s,this,t,n)}):this._pending.push(()=>this.setAttribute(t,n))}getAttribute(t){return dn(this,t)}getAttributes(){return Ns(this)}_write(t){t.writeTypeRef(Oo)}}const go=e=>new $t;class pn{constructor(t,n=()=>!0){this._filter=n,this._root=t,this._currentNode=t._start,this._firstCall=!0}[Symbol.iterator](){return this}next(){let t=this._currentNode,n=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(n)))do if(n=t.content.type,!t.deleted&&(n.constructor===Bt||n.constructor===Dt)&&n._start!==null)t=n._start;else for(;t!==null;)if(t.right!==null){t=t.right;break}else t.parent===this._root?t=null:t=t.parent._item;while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class Dt extends j{constructor(){super();this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Dt}clone(){const t=new Dt;return t.insert(0,this.toArray().map(n=>n instanceof j?n.clone():n)),t}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new pn(this,t)}querySelector(t){t=t.toUpperCase();const s=new pn(this,r=>r.nodeName&&r.nodeName.toUpperCase()===t).next();return s.done?null:s.value}querySelectorAll(t){return t=t.toUpperCase(),ut(new pn(this,n=>n.nodeName&&n.nodeName.toUpperCase()===t))}_callObserver(t,n){_e(this,t,new mo(this,n,t))}toString(){return Ts(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,n={},s){const r=t.createDocumentFragment();return s!==void 0&&s._createAssociation(r,this),te(this,i=>{r.insertBefore(i.toDOM(t,n,s),null)}),r}insert(t,n){this.doc!==null?A(this.doc,s=>{Us(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}insertAfter(t,n){if(this.doc!==null)A(this.doc,s=>{const r=t&&t instanceof j?t._item:t;Ce(s,this,r,n)});else{const s=this._prelimContent,r=t===null?0:s.findIndex(i=>i===t)+1;if(r===0&&t!==null)throw dt("Reference item not found");s.splice(r,0,...n)}}delete(t,n=1){this.doc!==null?A(this.doc,s=>{Rs(s,this,t,n)}):this._prelimContent.splice(t,n)}toArray(){return Ls(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return Os(this,t)}slice(t=0,n=this.length){return Ms(this,t,n)}forEach(t){te(this,t)}_write(t){t.writeTypeRef(Uo)}}const po=e=>new Dt;class Bt extends Dt{constructor(t="UNDEFINED"){super();this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,n){super._integrate(t,n),this._prelimAttrs.forEach((s,r)=>{this.setAttribute(r,s)}),this._prelimAttrs=null}_copy(){return new Bt(this.nodeName)}clone(){const t=new Bt(this.nodeName),n=this.getAttributes();return Jr(n,(s,r)=>{typeof s=="string"&&t.setAttribute(r,s)}),t.insert(0,this.toArray().map(s=>s instanceof j?s.clone():s)),t}toString(){const t=this.getAttributes(),n=[],s=[];for(const c in t)s.push(c);s.sort();const r=s.length;for(let c=0;c<r;c++){const l=s[c];n.push(l+'="'+t[l]+'"')}const i=this.nodeName.toLocaleLowerCase(),o=n.length>0?" "+n.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?A(this.doc,n=>{ve(n,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,n){this.doc!==null?A(this.doc,s=>{un(s,this,t,n)}):this._prelimAttrs.set(t,n)}getAttribute(t){return dn(this,t)}hasAttribute(t){return Vs(this,t)}getAttributes(t){return t?ro(this,t):Ns(this)}toDOM(t=document,n={},s){const r=t.createElement(this.nodeName),i=this.getAttributes();for(const o in i){const c=i[o];typeof c=="string"&&r.setAttribute(o,c)}return te(this,o=>{r.appendChild(o.toDOM(t,n,s))}),s!==void 0&&s._createAssociation(r,this),r}_write(t){t.writeTypeRef(xo),t.writeKey(this.nodeName)}}const wo=e=>new Bt(e.readKey());class mo extends Se{constructor(t,n,s){super(t,s);this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(r=>{r===null?this.childListChanged=!0:this.attributesChanged.add(r)})}}class Ae extends Vt{constructor(t){super();this.hookName=t}_copy(){return new Ae(this.hookName)}clone(){const t=new Ae(this.hookName);return this.forEach((n,s)=>{t.set(s,n)}),t}toDOM(t=document,n={},s){const r=n[this.hookName];let i;return r!==void 0?i=r.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),s!==void 0&&s._createAssociation(i,this),i}_write(t){t.writeTypeRef(Ro),t.writeKey(this.hookName)}}const yo=e=>new Ae(e.readKey());class Ie extends $t{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new Ie}clone(){const t=new Ie;return t.applyDelta(this.toDelta()),t}toDOM(t=document,n,s){const r=t.createTextNode(this.toString());return s!==void 0&&s._createAssociation(r,this),r}toString(){return this.toDelta().map(t=>{const n=[];for(const r in t.attributes){const i=[];for(const o in t.attributes[r])i.push({key:o,value:t.attributes[r][o]});i.sort((o,c)=>o.key<c.key?-1:1),n.push({nodeName:r,attrs:i})}n.sort((r,i)=>r.nodeName<i.nodeName?-1:1);let s="";for(let r=0;r<n.length;r++){const i=n[r];s+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){const c=i.attrs[o];s+=` ${c.key}="${c.value}"`}s+=">"}s+=t.insert;for(let r=n.length-1;r>=0;r--)s+=`</${n[r].nodeName}>`;return s}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(No)}}const bo=e=>new Ie;class wn{constructor(t,n){this.id=t,this.length=n}get deleted(){throw X()}mergeWith(t){return!1}write(t,n,s){throw X()}integrate(t,n){throw X()}}const So=0;class W extends wn{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){n>0&&(this.id.clock+=n,this.length-=n),bs(t.doc.store,this)}write(t,n){t.writeInfo(So),t.writeLen(this.length-n)}getMissing(t,n){return null}}class ee{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new ee(this.content)}splice(t){throw X()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeBuf(this.content)}getRef(){return 3}}const ko=e=>new ee(e.readBuf());class ne{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new ne(this.len)}splice(t){const n=new ne(this.len-t);return this.len=t,n}mergeWith(t){return this.len+=t.len,!0}integrate(t,n){pe(t.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(t){}gc(t){}write(t,n){t.writeLen(this.len-n)}getRef(){return 1}}const _o=e=>new ne(e.readLen()),Js=(e,t)=>new Ot(xe(Ht({guid:e},t),{shouldLoad:t.shouldLoad||t.autoLoad||!1}));class se{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const n={};this.opts=n,t.gc||(n.gc=!1),t.autoLoad&&(n.autoLoad=!0),t.meta!==null&&(n.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new se(Js(this.doc.guid,this.opts))}splice(t){throw X()}mergeWith(t){return!1}integrate(t,n){this.doc._item=n,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,n){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const Co=e=>new se(Js(e.readString(),e.readAny()));class Et{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Et(this.embed)}splice(t){throw X()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeJSON(this.embed)}getRef(){return 5}}const vo=e=>new Et(e.readJSON());class R{constructor(t,n){this.key=t,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new R(this.key,this.value)}splice(t){throw X()}mergeWith(t){return!1}integrate(t,n){const s=n.parent;s._searchMarker=null,s._hasFormatting=!0}delete(t){}gc(t){}write(t,n){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const Do=e=>new R(e.readKey(),e.readJSON());class Me{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Me(this.arr)}splice(t){const n=new Me(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const Eo=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++){const r=e.readString();r==="undefined"?n.push(void 0):n.push(JSON.parse(r))}return new Me(n)};class At{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new At(this.arr)}splice(t){const n=new At(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeAny(i)}}getRef(){return 8}}const Ao=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++)n.push(e.readAny());return new At(n)};class tt{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new tt(this.str)}splice(t){const n=new tt(this.str.slice(t));this.str=this.str.slice(0,t);const s=this.str.charCodeAt(t-1);return s>=55296&&s<=56319&&(this.str=this.str.slice(0,t-1)+"\uFFFD",n.str="\uFFFD"+n.str.slice(1)),n}mergeWith(t){return this.str+=t.str,!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const Io=e=>new tt(e.readString()),Mo=[oo,lo,go,wo,po,yo,bo],Lo=0,To=1,Oo=2,xo=3,Uo=4,Ro=5,No=6;class ct{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ct(this.type._copy())}splice(t){throw X()}mergeWith(t){return!1}integrate(t,n){this.type._integrate(t.doc,n)}delete(t){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(t.beforeState.get(n.id.client)||0)&&t._mergeStructs.push(n):n.delete(t),n=n.right;this.type._map.forEach(s=>{s.deleted?s.id.clock<(t.beforeState.get(s.id.client)||0)&&t._mergeStructs.push(s):s.delete(t)}),t.changed.delete(this.type)}gc(t){let n=this.type._start;for(;n!==null;)n.gc(t,!0),n=n.right;this.type._start=null,this.type._map.forEach(s=>{for(;s!==null;)s.gc(t,!0),s=s.left}),this.type._map=new Map}write(t,n){this.type._write(t)}getRef(){return 7}}const Vo=e=>new ct(Mo[e.readTypeRef()](e)),Le=(e,t,n)=>{const{client:s,clock:r}=t.id,i=new N(D(s,r+n),t,D(s,r+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=D(t.redone.client,t.redone.clock+n)),t.right=i,i.right!==null&&(i.right.left=i),e._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=n,i};class N extends wn{constructor(t,n,s,r,i,o,c,l){super(t,l.getLength());this.origin=s,this.left=n,this.right=r,this.rightOrigin=i,this.parent=o,this.parentSub=c,this.redone=null,this.content=l,this.info=this.content.isCountable()?On:0}set marker(t){(this.info&Ve)>0!==t&&(this.info^=Ve)}get marker(){return(this.info&Ve)>0}get keep(){return(this.info&Tn)>0}set keep(t){this.keep!==t&&(this.info^=Tn)}get countable(){return(this.info&On)>0}get deleted(){return(this.info&Ne)>0}set deleted(t){this.deleted!==t&&(this.info^=Ne)}markDeleted(){this.info|=Ne}getMissing(t,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=$(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=$(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ut&&this.id.client!==this.parent.client&&this.parent.clock>=$(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Ss(t,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=pt(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===W||this.right&&this.right.constructor===W)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===N&&(this.parent=this.left.parent,this.parentSub=this.left.parentSub),this.right&&this.right.constructor===N&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ut){const s=rn(n,this.parent);s.constructor===W?this.parent=null:this.parent=s.content.type}return null}integrate(t,n){if(n>0&&(this.id.clock+=n,this.left=Ss(t,t.doc.store,D(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let s=this.left,r;if(s!==null)r=s.right;else if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start;const i=new Set,o=new Set;for(;r!==null&&r!==this.right;){if(o.add(r),i.add(r),we(this.origin,r.origin)){if(r.id.client<this.id.client)s=r,i.clear();else if(we(this.rightOrigin,r.rightOrigin))break}else if(r.origin!==null&&o.has(rn(t.doc.store,r.origin)))i.has(rn(t.doc.store,r.origin))||(s=r,i.clear());else break;r=r.right}this.left=s}if(this.left!==null){const s=this.left.right;this.right=s,this.left.right=this}else{let s;if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start,this.parent._start=this;this.right=s}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),bs(t.doc.store,this),this.content.integrate(t,this),Cs(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new W(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:D(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&we(t.origin,this.lastId)&&this.right===t&&we(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const n=this.parent._searchMarker;return n&&n.forEach(s=>{s.p===t&&(s.p=this,!this.deleted&&this.countable&&(s.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),pe(t.deleteSet,this.id.client,this.id.clock,this.length),Cs(t,n,this.parentSub),this.content.delete(t)}}gc(t,n){if(!this.deleted)throw K();this.content.gc(t),n?Pi(t,this,new W(this.id,this.length)):this.content=new ne(this.length)}write(t,n){const s=n>0?D(this.id.client,this.id.clock+n-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&le|(s===null?0:J)|(r===null?0:rt)|(i===null?0:Gt);if(t.writeInfo(o),s!==null&&t.writeLeftID(s),r!==null&&t.writeRightID(r),s===null&&r===null){const c=this.parent;if(c._item!==void 0){const l=c._item;if(l===null){const h=Bi(c);t.writeParentInfo(!0),t.writeString(h)}else t.writeParentInfo(!1),t.writeLeftID(l.id)}else c.constructor===String?(t.writeParentInfo(!0),t.writeString(c)):c.constructor===Ut?(t.writeParentInfo(!1),t.writeLeftID(c)):K();i!==null&&t.writeString(i)}this.content.write(t,n)}}const Ws=(e,t)=>Fo[t&le](e),Fo=[()=>{K()},_o,Eo,ko,Io,vo,Do,Vo,Ao,Co,()=>{K()}],$o=10;class z extends wn{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){K()}write(t,n){t.writeInfo($o),b(t.restEncoder,this.length-n)}getMissing(t,n){return null}}const zs=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:{},Ys="__ $YJS$ __";zs[Ys]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438"),zs[Ys]=!0;const qs=0,mn=1,Xs=2,Ks=(e,t)=>{b(e,qs);const n=Fi(t);x(e,n)},Qs=(e,t,n)=>{b(e,mn),x(e,Ui(t,n))},Bo=(e,t,n)=>Qs(t,n,H(e)),Zs=(e,t,n)=>{try{Ti(t,H(e),n)}catch(s){console.error("Caught error while handling a Yjs update",s)}},jo=(e,t)=>{b(e,Xs),x(e,t)},Po=Zs,Ho=(e,t,n,s)=>{const r=v(e);switch(r){case qs:Bo(e,t,n);break;case mn:Zs(e,n,s);break;case Xs:Po(e,n,s);break;default:throw new Error("Unknown message type")}return r},yn=3e4;class Go extends In{constructor(t){super();this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const n=fe();this.getLocalState()!==null&&yn/2<=n-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const s=[];this.meta.forEach((r,i)=>{i!==this.clientID&&yn<=n-r.lastUpdated&&this.states.has(i)&&s.push(i)}),s.length>0&&bn(this,s,"timeout")},st(yn/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){const n=this.clientID,s=this.meta.get(n),r=s===void 0?0:s.clock+1,i=this.states.get(n);t===null?this.states.delete(n):this.states.set(n,t),this.meta.set(n,{clock:r,lastUpdated:fe()});const o=[],c=[],l=[],h=[];t===null?h.push(n):i==null?t!=null&&o.push(n):(c.push(n),Xt(i,t)||l.push(n)),(o.length>0||l.length>0||h.length>0)&&this.emit("change",[{added:o,updated:l,removed:h},"local"]),this.emit("update",[{added:o,updated:c,removed:h},"local"])}setLocalStateField(t,n){const s=this.getLocalState();s!==null&&this.setLocalState(xe(Ht({},s),{[t]:n}))}getStates(){return this.states}}const bn=(e,t,n)=>{const s=[];for(let r=0;r<t.length;r++){const i=t[r];if(e.states.has(i)){if(e.states.delete(i),i===e.clientID){const o=e.meta.get(i);e.meta.set(i,{clock:o.clock+1,lastUpdated:fe()})}s.push(i)}}s.length>0&&(e.emit("change",[{added:[],updated:[],removed:s},n]),e.emit("update",[{added:[],updated:[],removed:s},n]))},re=(e,t,n=e.states)=>{const s=t.length,r=G();b(r,s);for(let i=0;i<s;i++){const o=t[i],c=n.get(o)||null,l=e.meta.get(o).clock;b(r,o),b(r,l),_t(r,JSON.stringify(c))}return O(r)},Jo=(e,t,n)=>{const s=ft(t),r=fe(),i=[],o=[],c=[],l=[],h=v(s);for(let a=0;a<h;a++){const u=v(s);let d=v(s);const f=JSON.parse(gt(s)),p=e.meta.get(u),S=e.states.get(u),I=p===void 0?0:p.clock;(I<d||I===d&&f===null&&e.states.has(u))&&(f===null?u===e.clientID&&e.getLocalState()!=null?d++:e.states.delete(u):e.states.set(u,f),e.meta.set(u,{clock:d,lastUpdated:r}),p===void 0&&f!==null?i.push(u):p!==void 0&&f===null?l.push(u):f!==null&&(Xt(f,S)||c.push(u),o.push(u)))}(i.length>0||c.length>0||l.length>0)&&e.emit("change",[{added:i,updated:c,removed:l},n]),(i.length>0||o.length>0||l.length>0)&&e.emit("update",[{added:i,updated:o,removed:l},n])},Wo=0,zo=(e,t,n)=>{switch(v(e)){case Wo:n(t,gt(e))}},tr=new Map;class Yo{constructor(t){this.room=t,this.onmessage=null,this._onChange=n=>n.key===t&&this.onmessage!==null&&this.onmessage({data:ci(n.newValue||"")}),jr(this._onChange)}postMessage(t){Wn.setItem(this.room,oi(ei(t)))}close(){Pr(this._onChange)}}const qo=typeof BroadcastChannel=="undefined"?Yo:BroadcastChannel,Sn=e=>nt(tr,e,()=>{const t=bt(),n=new qo(e);return n.onmessage=s=>t.forEach(r=>r(s.data,"broadcastchannel")),{bc:n,subs:t}}),Xo=(e,t)=>(Sn(e).subs.add(t),t),Ko=(e,t)=>{const n=Sn(e),s=n.subs.delete(t);return s&&n.subs.size===0&&(n.bc.close(),tr.delete(e)),s},jt=(e,t,n=null)=>{const s=Sn(e);s.bc.postMessage(t),s.subs.forEach(r=>r(t,n))};function er(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,tc(s.key),s)}}function Qo(e,t,n){return t&&er(e.prototype,t),n&&er(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function kn(){return kn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},kn.apply(this,arguments)}function Zo(e,t){if(typeof e!="object"||e===null)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var s=n.call(e,t||"default");if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function tc(e){var t=Zo(e,"string");return typeof t=="symbol"?t:String(t)}var Pt,P;(function(e){e[e.Sync=0]="Sync",e[e.Awareness=1]="Awareness",e[e.Auth=2]="Auth",e[e.QueryAwareness=3]="QueryAwareness"})(P||(P={}));var ec=function(t,n){console.warn("Permission denied to access "+t.channelName+`.
`+n)},nc=(Pt={},Pt[P.Sync]=function(e,t,n,s){b(e,P.Sync);var r=Ho(t,e,n.doc,n);s&&r===mn&&!n.synced&&(n.synced=!0)},Pt[P.QueryAwareness]=function(e,t,n,s,r){b(e,P.Awareness),x(e,re(n.awareness,Array.from(n.awareness.getStates().keys())))},Pt[P.Awareness]=function(e,t,n){Jo(n.awareness,H(t),n)},Pt[P.Auth]=function(e,t,n){zo(t,n.doc,function(s,r){return ec(n,r)})},Pt),sc=function(){function e(n,s,r,i,o){var c=this,l=o===void 0?{}:o,h=l.awareness,a=h===void 0?new Go(n):h,u=l.disableBc,d=u===void 0?!1:u;this.bcSubscriber=function(f,p){if(p!==c){var S=c.process(new Uint8Array(f),!1);$e(S)>1&&jt(c.bcChannelName,O(S),c)}},this.updateHandler=function(f,p){if(p!==c){var S=G();b(S,P.Sync),jo(S,f),c.send(O(S))}},this.unloadHandler=function(){bn(c.awareness,[c.doc.clientID],"window unload")},this.awarenessUpdateHandler=function(f,p){var S=f.added,I=f.updated,yt=f.removed,lt=S.concat(I).concat(yt),et=G();b(et,P.Awareness),x(et,re(c.awareness,lt)),c.send(O(et))},this.consumer=s,this.channelName=r,this.bcChannelName=r+"_"+Object.entries(i).map(function(f,p){return f+"-"+p}).join("_"),this.params=i,this.doc=n,this.awareness=a,this.bcconnected=!1,this.disableBc=d,this._synced=!1,this.doc.on("update",this.updateHandler),typeof window!="undefined"?window.addEventListener("unload",this.unloadHandler):typeof process!="undefined"&&process.on("exit",this.unloadHandler),a.on("update",this.awarenessUpdateHandler),this.connect()}var t=e.prototype;return t.destroy=function(){this.disconnect(),typeof window!="undefined"?window.removeEventListener("unload",this.unloadHandler):typeof process!="undefined"&&process.off("exit",this.unloadHandler),this.awareness.off("update",this.awarenessUpdateHandler),this.doc.off("update",this.updateHandler)},t.send=function(s){var r,i=rc(s);(r=this.channel)==null||r.send({update:i}),this.bcconnected&&jt(this.bcChannelName,s,this)},t.process=function(s,r){var i=ft(s),o=G(),c=v(i),l=nc[c];return l?l(o,i,this,r,c):console.error("Unable to compute message"),o},t.subscribe=function(){var s=this;this.synced=!1,this.channel=this.consumer.subscriptions.create(kn({channel:this.channelName},this.params),{received:function(i){var o=i.update,c=ic(o),l=s.process(c,!0);$e(l)>1&&s.send(O(l))},disconnected:function(){s.synced=!1,bn(s.awareness,Array.from(s.awareness.getStates().keys()).filter(function(i){return i!==s.doc.clientID}),s)},connected:function(){var i=G();if(b(i,P.Sync),Ks(i,s.doc),s.send(O(i)),s.awareness.getLocalState()!==null){var o=G();b(o,P.Awareness),x(o,re(s.awareness,[s.doc.clientID])),s.send(O(o))}}})},t.connectBc=function(){if(!this.disableBc){this.bcconnected||(Xo(this.bcChannelName,this.bcSubscriber),this.bcconnected=!0);var s=G();b(s,P.Sync),Ks(s,this.doc),jt(this.bcChannelName,O(s),this);var r=G();b(r,P.Sync),Qs(r,this.doc),jt(this.bcChannelName,O(r),this);var i=G();b(i,P.QueryAwareness),jt(this.bcChannelName,O(i),this);var o=G();b(o,P.Awareness),x(o,re(this.awareness,[this.doc.clientID])),jt(this.bcChannelName,O(o),this)}},t.disconnectBc=function(){var s=G();b(s,P.Awareness),x(s,re(this.awareness,[this.doc.clientID],new Map)),this.send(O(s)),this.bcconnected&&(Ko(this.bcChannelName,this.bcSubscriber),this.bcconnected=!1)},t.disconnect=function(){var s;this.disconnectBc(),(s=this.channel)==null||s.unsubscribe(),this.channel!=null&&(this.channel=void 0)},t.connect=function(){this.channel==null&&(this.subscribe(),this.connectBc())},Qo(e,[{key:"synced",get:function(){return this._synced},set:function(s){this._synced!==s&&(this._synced=s)}}]),e}();function rc(e){var t=Array.from(e,function(n){return String.fromCharCode(n)}).join("");return btoa(t)}function ic(e){return Uint8Array.from(atob(e),function(t){return t.charCodeAt(0)})}var Te={logger:typeof console!="undefined"?console:void 0,WebSocket:typeof WebSocket!="undefined"?WebSocket:void 0},L={log(...e){this.enabled&&(e.push(Date.now()),Te.logger.log("[ActionCable]",...e))}};const ie=()=>new Date().getTime(),Oe=e=>(ie()-e)/1e3;class _n{constructor(t){this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.reconnectAttempts=0}start(){this.isRunning()||(this.startedAt=ie(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),L.log(`ConnectionMonitor started. stale threshold = ${this.constructor.staleThreshold} s`))}stop(){this.isRunning()&&(this.stoppedAt=ie(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),L.log("ConnectionMonitor stopped"))}isRunning(){return this.startedAt&&!this.stoppedAt}recordPing(){this.pingedAt=ie()}recordConnect(){this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,L.log("ConnectionMonitor recorded connect")}recordDisconnect(){this.disconnectedAt=ie(),L.log("ConnectionMonitor recorded disconnect")}startPolling(){this.stopPolling(),this.poll()}stopPolling(){clearTimeout(this.pollTimeout)}poll(){this.pollTimeout=setTimeout(()=>{this.reconnectIfStale(),this.poll()},this.getPollInterval())}getPollInterval(){const{staleThreshold:t,reconnectionBackoffRate:n}=this.constructor,s=Math.pow(1+n,Math.min(this.reconnectAttempts,10)),i=(this.reconnectAttempts===0?1:n)*Math.random();return t*1e3*s*(1+i)}reconnectIfStale(){this.connectionIsStale()&&(L.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, time stale = ${Oe(this.refreshedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`),this.reconnectAttempts++,this.disconnectedRecently()?L.log(`ConnectionMonitor skipping reopening recent disconnect. time disconnected = ${Oe(this.disconnectedAt)} s`):(L.log("ConnectionMonitor reopening"),this.connection.reopen()))}get refreshedAt(){return this.pingedAt?this.pingedAt:this.startedAt}connectionIsStale(){return Oe(this.refreshedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&Oe(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){document.visibilityState==="visible"&&setTimeout(()=>{(this.connectionIsStale()||!this.connection.isOpen())&&(L.log(`ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ${document.visibilityState}`),this.connection.reopen())},200)}}_n.staleThreshold=6,_n.reconnectionBackoffRate=.15;var nr={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart",remote:"remote"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]};const{message_types:oe,protocols:Cn}=nr,oc=Cn.slice(0,Cn.length-1),sr=[].indexOf;class vn{constructor(t){this.open=this.open.bind(this),this.consumer=t,this.subscriptions=this.consumer.subscriptions,this.monitor=new _n(this),this.disconnected=!0}send(t){return this.isOpen()?(this.webSocket.send(JSON.stringify(t)),!0):!1}open(){if(this.isActive())return L.log(`Attempted to open WebSocket, but existing socket is ${this.getState()}`),!1;{const t=[...Cn,...this.consumer.subprotocols||[]];return L.log(`Opening WebSocket, current state is ${this.getState()}, subprotocols: ${t}`),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new Te.WebSocket(this.consumer.url,t),this.installEventHandlers(),this.monitor.start(),!0}}close({allowReconnect:t}={allowReconnect:!0}){if(t||this.monitor.stop(),this.isOpen())return this.webSocket.close()}reopen(){if(L.log(`Reopening WebSocket, current state is ${this.getState()}`),this.isActive())try{return this.close()}catch(t){L.log("Failed to reopen WebSocket",t)}finally{L.log(`Reopening WebSocket in ${this.constructor.reopenDelay}ms`),setTimeout(this.open,this.constructor.reopenDelay)}else return this.open()}getProtocol(){if(this.webSocket)return this.webSocket.protocol}isOpen(){return this.isState("open")}isActive(){return this.isState("open","connecting")}triedToReconnect(){return this.monitor.reconnectAttempts>0}isProtocolSupported(){return sr.call(oc,this.getProtocol())>=0}isState(...t){return sr.call(t,this.getState())>=0}getState(){if(this.webSocket){for(let t in Te.WebSocket)if(Te.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase()}return null}installEventHandlers(){for(let t in this.events){const n=this.events[t].bind(this);this.webSocket[`on${t}`]=n}}uninstallEventHandlers(){for(let t in this.events)this.webSocket[`on${t}`]=function(){}}}vn.reopenDelay=500,vn.prototype.events={message(e){if(!this.isProtocolSupported())return;const{identifier:t,message:n,reason:s,reconnect:r,type:i}=JSON.parse(e.data);switch(i){case oe.welcome:return this.triedToReconnect()&&(this.reconnectAttempted=!0),this.monitor.recordConnect(),this.subscriptions.reload();case oe.disconnect:return L.log(`Disconnecting. Reason: ${s}`),this.close({allowReconnect:r});case oe.ping:return this.monitor.recordPing();case oe.confirmation:return this.subscriptions.confirmSubscription(t),this.reconnectAttempted?(this.reconnectAttempted=!1,this.subscriptions.notify(t,"connected",{reconnected:!0})):this.subscriptions.notify(t,"connected",{reconnected:!1});case oe.rejection:return this.subscriptions.reject(t);default:return this.subscriptions.notify(t,"received",n)}},open(){if(L.log(`WebSocket onopen event, using '${this.getProtocol()}' subprotocol`),this.disconnected=!1,!this.isProtocolSupported())return L.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close(e){if(L.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error(){L.log("WebSocket onerror event")}};const cc=function(e,t){if(t!=null)for(let n in t){const s=t[n];e[n]=s}return e};class lc{constructor(t,n={},s){this.consumer=t,this.identifier=JSON.stringify(n),cc(this,s)}perform(t,n={}){return n.action=t,this.send(n)}send(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})}unsubscribe(){return this.consumer.subscriptions.remove(this)}}class ac{constructor(t){this.subscriptions=t,this.pendingSubscriptions=[]}guarantee(t){this.pendingSubscriptions.indexOf(t)==-1?(L.log(`SubscriptionGuarantor guaranteeing ${t.identifier}`),this.pendingSubscriptions.push(t)):L.log(`SubscriptionGuarantor already guaranteeing ${t.identifier}`),this.startGuaranteeing()}forget(t){L.log(`SubscriptionGuarantor forgetting ${t.identifier}`),this.pendingSubscriptions=this.pendingSubscriptions.filter(n=>n!==t)}startGuaranteeing(){this.stopGuaranteeing(),this.retrySubscribing()}stopGuaranteeing(){clearTimeout(this.retryTimeout)}retrySubscribing(){this.retryTimeout=setTimeout(()=>{this.subscriptions&&typeof this.subscriptions.subscribe=="function"&&this.pendingSubscriptions.map(t=>{L.log(`SubscriptionGuarantor resubscribing ${t.identifier}`),this.subscriptions.subscribe(t)})},500)}}class hc{constructor(t){this.consumer=t,this.guarantor=new ac(this),this.subscriptions=[]}create(t,n){const s=t,r=typeof s=="object"?s:{channel:s},i=new lc(this.consumer,r,n);return this.add(i)}add(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.subscribe(t),t}remove(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t}reject(t){return this.findAll(t).map(n=>(this.forget(n),this.notify(n,"rejected"),n))}forget(t){return this.guarantor.forget(t),this.subscriptions=this.subscriptions.filter(n=>n!==t),t}findAll(t){return this.subscriptions.filter(n=>n.identifier===t)}reload(){return this.subscriptions.map(t=>this.subscribe(t))}notifyAll(t,...n){return this.subscriptions.map(s=>this.notify(s,t,...n))}notify(t,n,...s){let r;return typeof t=="string"?r=this.findAll(t):r=[t],r.map(i=>typeof i[n]=="function"?i[n](...s):void 0)}subscribe(t){this.sendCommand(t,"subscribe")&&this.guarantor.guarantee(t)}confirmSubscription(t){L.log(`Subscription confirmed ${t}`),this.findAll(t).map(n=>this.guarantor.forget(n))}sendCommand(t,n){const{identifier:s}=t;return this.consumer.send({command:n,identifier:s})}}class uc{constructor(t){this._url=t,this.subscriptions=new hc(this),this.connection=new vn(this),this.subprotocols=[]}get url(){return dc(this._url)}send(t){return this.connection.send(t)}connect(){return this.connection.open()}disconnect(){return this.connection.close({allowReconnect:!1})}ensureActiveConnection(){if(!this.connection.isActive())return this.connection.open()}addSubProtocol(t){this.subprotocols=[...this.subprotocols,t]}}function dc(e){if(typeof e=="function"&&(e=e()),e&&!/^wss?:/i.test(e)){const t=document.createElement("a");return t.href=e,t.href=t.href,t.protocol=t.protocol.replace("http","ws"),t.href}else return e}function fc(e=gc("url")||nr.default_mount_path){return new uc(e)}function gc(e){const t=document.head.querySelector(`meta[name='action-cable-${e}']`);if(t)return t.getAttribute("content")}var C=class{static clamp(e,t,n){return Math.max(t,typeof n!="undefined"?Math.min(e,n):e)}static clampV(e,t,n){return e.map(s=>n?C.clamp(s,t,n):C.clamp(s,t))}static cross(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(t[1]-e[1])}static snap(e,t=1){return[Math.round(e[0]/t)*t,Math.round(e[1]/t)*t]}},k=C;k.neg=e=>[-e[0],-e[1]],k.add=(e,t)=>[e[0]+t[0],e[1]+t[1]],k.addScalar=(e,t)=>[e[0]+t,e[1]+t],k.sub=(e,t)=>[e[0]-t[0],e[1]-t[1]],k.subScalar=(e,t)=>[e[0]-t,e[1]-t],k.vec=(e,t)=>[t[0]-e[0],t[1]-e[1]],k.mul=(e,t)=>[e[0]*t,e[1]*t],k.mulV=(e,t)=>[e[0]*t[0],e[1]*t[1]],k.div=(e,t)=>[e[0]/t,e[1]/t],k.divV=(e,t)=>[e[0]/t[0],e[1]/t[1]],k.per=e=>[e[1],-e[0]],k.dpr=(e,t)=>e[0]*t[0]+e[1]*t[1],k.cpr=(e,t)=>e[0]*t[1]-t[0]*e[1],k.len2=e=>e[0]*e[0]+e[1]*e[1],k.len=e=>Math.hypot(e[0],e[1]),k.pry=(e,t)=>C.dpr(e,t)/C.len(t),k.uni=e=>C.div(e,C.len(e)),k.normalize=e=>C.uni(e),k.tangent=(e,t)=>C.uni(C.sub(e,t)),k.dist2=(e,t)=>C.len2(C.sub(e,t)),k.dist=(e,t)=>Math.hypot(e[1]-t[1],e[0]-t[0]),k.fastDist=(e,t)=>{const n=[t[0]-e[0],t[1]-e[1]],s=[Math.abs(n[0]),Math.abs(n[1])];let r=1/Math.max(s[0],s[1]);return r=r*(1.29289-(s[0]+s[1])*r*.29289),[n[0]*r,n[1]*r]},k.ang=(e,t)=>Math.atan2(C.cpr(e,t),C.dpr(e,t)),k.angle=(e,t)=>Math.atan2(t[1]-e[1],t[0]-e[0]),k.med=(e,t)=>C.mul(C.add(e,t),.5),k.rot=(e,t=0)=>[e[0]*Math.cos(t)-e[1]*Math.sin(t),e[0]*Math.sin(t)+e[1]*Math.cos(t)],k.rotWith=(e,t,n=0)=>{if(n===0)return e;const s=Math.sin(n),r=Math.cos(n),i=e[0]-t[0],o=e[1]-t[1],c=i*r-o*s,l=i*s+o*r;return[c+t[0],l+t[1]]},k.isEqual=(e,t)=>e[0]===t[0]&&e[1]===t[1],k.lrp=(e,t,n)=>C.add(e,C.mul(C.sub(t,e),n)),k.int=(e,t,n,s,r=1)=>{const i=(C.clamp(n,s)-n)/(s-n);return C.add(C.mul(e,1-i),C.mul(t,r))},k.ang3=(e,t,n)=>{const s=C.vec(t,e),r=C.vec(t,n);return C.ang(s,r)},k.abs=e=>[Math.abs(e[0]),Math.abs(e[1])],k.rescale=(e,t)=>{const n=C.len(e);return[t*e[0]/n,t*e[1]/n]},k.isLeft=(e,t,n)=>(t[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(t[1]-e[1]),k.clockwise=(e,t,n)=>C.isLeft(e,t,n)>0,k.toFixed=(e,t=2)=>e.map(n=>+n.toFixed(t)),k.nearestPointOnLineThroughPoint=(e,t,n)=>C.add(e,C.mul(t,C.pry(C.sub(n,e),t))),k.distanceToLineThroughPoint=(e,t,n)=>C.dist(n,C.nearestPointOnLineThroughPoint(e,t,n)),k.nearestPointOnLineSegment=(e,t,n,s=!0)=>{const r=C.uni(C.sub(t,e)),i=C.add(e,C.mul(r,C.pry(C.sub(n,e),r)));if(s){if(i[0]<Math.min(e[0],t[0]))return e[0]<t[0]?e:t;if(i[0]>Math.max(e[0],t[0]))return e[0]>t[0]?e:t;if(i[1]<Math.min(e[1],t[1]))return e[1]<t[1]?e:t;if(i[1]>Math.max(e[1],t[1]))return e[1]>t[1]?e:t}return i},k.distanceToLineSegment=(e,t,n,s=!0)=>C.dist(n,C.nearestPointOnLineSegment(e,t,n,s)),k.nudge=(e,t,n)=>C.isEqual(e,t)?e:C.add(e,C.mul(C.uni(C.sub(t,e)),n)),k.nudgeAtAngle=(e,t,n)=>[Math.cos(t)*n+e[0],Math.sin(t)*n+e[1]],k.toPrecision=(e,t=4)=>[+e[0].toPrecision(t),+e[1].toPrecision(t)],k.pointsBetween=(e,t,n=6)=>Array.from(Array(n)).map((s,r)=>{const i=r/(n-1),o=Math.min(1,.5+Math.abs(.5-i));return[...C.lrp(e,t,i),o]}),k.slope=(e,t)=>e[0]===t[0]?NaN:(e[1]-t[1])/(e[0]-t[0]),k.max=(...e)=>[Math.max(...e.map(t=>t[0])),Math.max(...e.map(t=>t[1]))],k.min=(...e)=>[Math.max(...e.map(t=>t[0])),Math.max(...e.map(t=>t[1]))];var pc=class{constructor(e=[]){this.points=[],this.lengths=[],this.totalLength=0,this.addPoint=t=>{if(this.prev){const n=k.dist(this.prev,t);this.lengths.push(n),this.totalLength+=n,this.points.push(t)}this.prev=t},this.clear=()=>{this.points=this.prev?[this.prev]:[],this.totalLength=0},this.getSplinePoint=t=>{const{points:n}=this,s=n.length-1,r=Math.trunc(t),i=Math.min(r+1,s),o=Math.min(i+1,s),c=Math.min(o+1,s),l=i-1,h=t-r,a=h*h,u=a*h,d=-u+2*a-h,f=3*u-5*a+2,p=-3*u+4*a+h,S=u-a;return[(n[l][0]*d+n[i][0]*f+n[o][0]*p+n[c][0]*S)/2,(n[l][1]*d+n[i][1]*f+n[o][1]*p+n[c][1]*S)/2]},this.points=e,this.lengths=e.map((t,n,s)=>n===0?0:k.dist(t,s[n-1])),this.totalLength=this.lengths.reduce((t,n)=>t+n,0)}},Dn=class{constructor(e){this.state="idle",this.queue=[],this.timestamp=performance.now(),this.lastRequestId=0,this.timeoutId=0,this.spline=new pc,this.addPoint=t=>{clearTimeout(this.timeoutId);const n=performance.now(),s=Math.min(n-this.timestamp,Dn.MAX_INTERVAL);if(!this.prevPoint){this.spline.clear(),this.prevPoint=t,this.spline.addPoint(t),this.cb(t),this.state="stopped";return}if(this.state==="stopped"){if(k.dist(this.prevPoint,t)<4){this.cb(t);return}this.spline.clear(),this.spline.addPoint(this.prevPoint),this.spline.addPoint(this.prevPoint),this.spline.addPoint(t),this.state="idle"}else this.spline.addPoint(t);if(s<16){this.prevPoint=t,this.timestamp=n,this.cb(t);return}const r={start:this.spline.points.length-3,from:this.prevPoint,to:t,duration:s};switch(this.prevPoint=t,this.timestamp=n,this.state){case"idle":{this.state="animating",this.animateNext(r);break}case"animating":{this.queue.push(r);break}}},this.animateNext=t=>{const n=performance.now(),s=()=>{const r=(performance.now()-n)/t.duration;if(r<=1&&this.spline.points.length>0){try{this.cb(this.spline.getSplinePoint(r+t.start))}catch(o){console.warn(o)}this.lastRequestId=requestAnimationFrame(s);return}const i=this.queue.shift();i?(this.state="animating",this.animateNext(i)):(this.state="idle",this.timeoutId=setTimeout(()=>{this.state="stopped"},Dn.MAX_INTERVAL))};s()},this.dispose=()=>{clearTimeout(this.timeoutId)},this.cb=e}},rr=Dn;rr.MAX_INTERVAL=300;let wc=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");var mc=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},En={exports:{}};(function(e,t){(function(n,s){{var r=s();e&&e.exports&&(t=e.exports=r),t.randomColor=r}})(mc,function(){var n=null,s={};yt();var r=[],i=function(g){if(g=g||{},g.seed!==void 0&&g.seed!==null&&g.seed===parseInt(g.seed,10))n=g.seed;else if(typeof g.seed=="string")n=lr(g.seed);else{if(g.seed!==void 0&&g.seed!==null)throw new TypeError("The seed value must be an integer or string");n=null}var m,w,y;if(g.count!==null&&g.count!==void 0){for(var _=g.count,E=[],M=0;M<g.count;M++)r.push(!1);for(g.count=null;_>E.length;){var Y=i(g);n!==null&&(g.seed=n),E.push(Y)}return g.count=_,E}return m=o(g),w=c(m,g),y=l(m,w,g),h([m,w,y],g)};function o(g){if(r.length>0){var m=An(g.hue),w=p(m),y=(m[1]-m[0])/r.length,_=parseInt((w-m[0])/y);r[_]===!0?_=(_+2)%r.length:r[_]=!0;var E=(m[0]+_*y)%359,M=(m[0]+(_+1)*y)%359;return m=[E,M],w=p(m),w<0&&(w=360+w),w}else{var m=u(g.hue);return w=p(m),w<0&&(w=360+w),w}}function c(g,m){if(m.hue==="monochrome")return 0;if(m.luminosity==="random")return p([0,100]);var w=d(g),y=w[0],_=w[1];switch(m.luminosity){case"bright":y=55;break;case"dark":y=_-10;break;case"light":_=55;break}return p([y,_])}function l(g,m,w){var y=a(g,m),_=100;switch(w.luminosity){case"dark":_=y+20;break;case"light":y=(_+y)/2;break;case"random":y=0,_=100;break}return p([y,_])}function h(g,m){switch(m.format){case"hsvArray":return g;case"hslArray":return U(g);case"hsl":var w=U(g);return"hsl("+w[0]+", "+w[1]+"%, "+w[2]+"%)";case"hsla":var y=U(g),M=m.alpha||Math.random();return"hsla("+y[0]+", "+y[1]+"%, "+y[2]+"%, "+M+")";case"rgbArray":return lt(g);case"rgb":var _=lt(g);return"rgb("+_.join(", ")+")";case"rgba":var E=lt(g),M=m.alpha||Math.random();return"rgba("+E.join(", ")+", "+M+")";default:return S(g)}}function a(g,m){for(var w=f(g).lowerBounds,y=0;y<w.length-1;y++){var _=w[y][0],E=w[y][1],M=w[y+1][0],Y=w[y+1][1];if(m>=_&&m<=M){var at=(Y-E)/(M-_),q=E-at*_;return at*m+q}}return 0}function u(g){if(typeof parseInt(g)=="number"){var m=parseInt(g);if(m<360&&m>0)return[m,m]}if(typeof g=="string"){if(s[g]){var w=s[g];if(w.hueRange)return w.hueRange}else if(g.match(/^#?([0-9A-F]{3}|[0-9A-F]{6})$/i)){var y=et(g)[0];return[y,y]}}return[0,360]}function d(g){return f(g).saturationRange}function f(g){g>=334&&g<=360&&(g-=360);for(var m in s){var w=s[m];if(w.hueRange&&g>=w.hueRange[0]&&g<=w.hueRange[1])return s[m]}return"Color not found"}function p(g){if(n===null){var m=.618033988749895,w=Math.random();return w+=m,w%=1,Math.floor(g[0]+w*(g[1]+1-g[0]))}else{var y=g[1]||1,_=g[0]||0;n=(n*9301+49297)%233280;var E=n/233280;return Math.floor(_+E*(y-_))}}function S(g){var m=lt(g);function w(_){var E=_.toString(16);return E.length==1?"0"+E:E}var y="#"+w(m[0])+w(m[1])+w(m[2]);return y}function I(g,m,w){var y=w[0][0],_=w[w.length-1][0],E=w[w.length-1][1],M=w[0][1];s[g]={hueRange:m,lowerBounds:w,saturationRange:[y,_],brightnessRange:[E,M]}}function yt(){I("monochrome",null,[[0,0],[100,0]]),I("red",[-26,18],[[20,100],[30,92],[40,89],[50,85],[60,78],[70,70],[80,60],[90,55],[100,50]]),I("orange",[18,46],[[20,100],[30,93],[40,88],[50,86],[60,85],[70,70],[100,70]]),I("yellow",[46,62],[[25,100],[40,94],[50,89],[60,86],[70,84],[80,82],[90,80],[100,75]]),I("green",[62,178],[[30,100],[40,90],[50,85],[60,81],[70,74],[80,64],[90,50],[100,40]]),I("blue",[178,257],[[20,100],[30,86],[40,80],[50,74],[60,60],[70,52],[80,44],[90,39],[100,35]]),I("purple",[257,282],[[20,100],[30,87],[40,79],[50,70],[60,65],[70,59],[80,52],[90,45],[100,42]]),I("pink",[282,334],[[20,100],[30,90],[40,86],[60,84],[80,80],[90,75],[100,73]])}function lt(g){var m=g[0];m===0&&(m=1),m===360&&(m=359),m=m/360;var w=g[1]/100,y=g[2]/100,_=Math.floor(m*6),E=m*6-_,M=y*(1-w),Y=y*(1-E*w),at=y*(1-(1-E)*w),q=256,ht=256,It=256;switch(_){case 0:q=y,ht=at,It=M;break;case 1:q=Y,ht=y,It=M;break;case 2:q=M,ht=y,It=at;break;case 3:q=M,ht=Y,It=y;break;case 4:q=at,ht=M,It=y;break;case 5:q=y,ht=M,It=Y;break}var _c=[Math.floor(q*255),Math.floor(ht*255),Math.floor(It*255)];return _c}function et(g){g=g.replace(/^#/,""),g=g.length===3?g.replace(/(.)/g,"$1$1"):g;var m=parseInt(g.substr(0,2),16)/255,w=parseInt(g.substr(2,2),16)/255,y=parseInt(g.substr(4,2),16)/255,_=Math.max(m,w,y),E=_-Math.min(m,w,y),M=_?E/_:0;switch(_){case m:return[60*((w-y)/E%6)||0,M,_];case w:return[60*((y-m)/E+2)||0,M,_];case y:return[60*((m-w)/E+4)||0,M,_]}}function U(g){var m=g[0],w=g[1]/100,y=g[2]/100,_=(2-w)*y;return[m,Math.round(w*y/(_<1?_:2-_)*1e4)/100,_/2*100]}function lr(g){for(var m=0,w=0;w!==g.length&&!(m>=Number.MAX_SAFE_INTEGER);w++)m+=g.charCodeAt(w);return m}function An(g){if(isNaN(g)){if(typeof g=="string"){if(s[g]){var w=s[g];if(w.hueRange)return w.hueRange}else if(g.match(/^#?([0-9A-F]{3}|[0-9A-F]{6})$/i)){var y=et(g)[0];return f(y).hueRange}}}else{var m=parseInt(g);if(m<360&&m>0)return f(g).hueRange}return[0,360]}return i})})(En,En.exports);var yc=En.exports;function ir(e){return`<svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="10 9 34 34"
      width="36"
      height="36"
      fill="none"
      fillRule="evenodd"
    >
      <g fill="rgba(0,0,0,.2)" transform="translate(1,1)">
        <path d="m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z" />
        <path d="m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z" />
      </g>
      <g fill="white">
        <path d="m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z" />
        <path d="m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z" />
      </g>
      <g fill="${e}">
        <path d="m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z" />
        <path d="m13 10.814v11.188l2.969-2.866.428-.139h4.768z" />
      </g>
    </svg>`}function or(e){const t=`<div id="cursor_${e.id}" class="cursor">
    ${ir(e.color)}
    <p id="chat_${e.id}" class="chat" style="background-color: ${e.color}">${e.chat}</p>
  </div>`,n=document.createElement("template");return n.innerHTML=t,n.content.firstChild}const cr=()=>({triggerKey:"/",cursorDivId:"cursor-chat-layer",chatDivId:"cursor-chat-box",userMetaData:{},renderCursor:or,yDoc:void 0,color:void 0,shouldChangeUserCursor:void 0,signallingServers:["wss://signalling.communities.digital"]}),bc=/[\r\n%#()<>?[\\\]^`{|}]/g;function Sc(e){return e=e.replace(/"/g,"'"),e=e.replace(/>\s{1,}</g,"><"),e=e.replace(/\s{2,}/g," "),e.replace(bc,encodeURIComponent)}const kc=(e=`cursor-chat-room-${window.location.host+window.location.pathname}`,t={})=>{const{triggerKey:n,cursorDivId:s,chatDivId:r,userMetaData:i,renderCursor:o,color:c,yDoc:l,shouldChangeUserCursor:h}=Ht(Ht({},cr()),t),a=document.getElementById(s),u=document.getElementById(r);if(!a||!u)throw"Couldn't find cursor-chat-related divs! Make sure DOM content is fully loaded before initializing";const d={id:wc(),x:0,y:0,chat:"",color:c!=null?c:yc(),userMetaData:i};let f,p,S;l!==void 0?f=l:(f=new Ot,p=fc(),S=new sc(f,p,"CursorChatChannel",{id:`${e}`}));const I=f.getMap("state");let yt=!1;if(h){const U=Sc(ir(d.color));document.documentElement.style.cursor=`url("data:image/svg+xml,${U}"), auto`}const lt=()=>{I.delete(d.id),S==null||S.destroy()};addEventListener("beforeunload",lt),setInterval(()=>{yt&&(I.set(d.id,d),yt=!1)},50),document.onmousemove=U=>{d.x!==U.pageX&&d.y!==U.pageY&&(yt=!0,d.x=U.pageX,d.y=U.pageY,u.style.setProperty("transform",`translate(${d.x}px, ${d.y}px)`))},document.addEventListener("keydown",U=>{U.key===n?u.style.getPropertyValue("display")==="block"&&u.value===""?(U.preventDefault(),u.style.setProperty("display","none")):(U.preventDefault(),u.style.setProperty("display","block"),u.focus()):U.key==="Escape"?(U.preventDefault(),u.value="",u.style.setProperty("display","none")):U.key==="Enter"&&U.preventDefault()}),document.addEventListener("keyup",()=>{d.chat=u.value,yt=!0});const et=new Map;return I.observe(U=>{U.changes.keys.forEach((An,g)=>{if(g!==d.id)switch(An.action){case"add":const m=I.get(g),w=o(m);w.classList.add("new"),a.appendChild(w);const y=([q,ht])=>w.style.setProperty("transform",`translate(${q}px, ${ht}px)`),_=new rr(y);_.addPoint([m.x,m.y]),et.set(g,_);break;case"update":const E=I.get(g),M=document.getElementById(`cursor_${g}`),Y=document.getElementById(`chat_${g}`);E.chat===""?Y.classList.remove("show"):Y.classList.add("show"),Y.innerText=E.chat,M.classList.remove("new"),et.get(g).addPoint([E.x,E.y]);break;case"delete":const at=document.getElementById(`cursor_${g}`);at.classList.add("expiring"),setTimeout(()=>{at.remove(),et.delete(g)},1e3);break}})}),lt};V.DefaultConfig=cr,V.defaultCursorRenderer=or,V.initCursorChat=kc,Object.defineProperties(V,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
